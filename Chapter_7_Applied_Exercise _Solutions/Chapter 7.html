<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Shad Ali Shah">
<meta name="dcterms.date" content="2026-02-10">

<title>Moving Beyond Linearity</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="Chapter 7_files/libs/clipboard/clipboard.min.js"></script>
<script src="Chapter 7_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="Chapter 7_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="Chapter 7_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="Chapter 7_files/libs/quarto-html/popper.min.js"></script>
<script src="Chapter 7_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Chapter 7_files/libs/quarto-html/anchor.min.js"></script>
<link href="Chapter 7_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Chapter 7_files/libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Chapter 7_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Chapter 7_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Chapter 7_files/libs/bootstrap/bootstrap-4d7f0bce1131f3e5f9547cd857cfbfc8.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul class="collapse">
  <li><a href="#chapter-7" id="toc-chapter-7" class="nav-link active" data-scroll-target="#chapter-7"><span class="header-section-number">1</span> Chapter 7</a>
  <ul class="collapse">
  <li><a href="#exercise-6" id="toc-exercise-6" class="nav-link" data-scroll-target="#exercise-6"><span class="header-section-number">1.1</span> Exercise 6</a></li>
  <li><a href="#exercise-7" id="toc-exercise-7" class="nav-link" data-scroll-target="#exercise-7"><span class="header-section-number">1.2</span> Exercise 7</a></li>
  <li><a href="#exercise-8" id="toc-exercise-8" class="nav-link" data-scroll-target="#exercise-8"><span class="header-section-number">1.3</span> Exercise 8</a></li>
  <li><a href="#exercise-9" id="toc-exercise-9" class="nav-link" data-scroll-target="#exercise-9"><span class="header-section-number">1.4</span> Exercise 9</a></li>
  <li><a href="#exercise-10" id="toc-exercise-10" class="nav-link" data-scroll-target="#exercise-10"><span class="header-section-number">1.5</span> Exercise 10</a></li>
  <li><a href="#exercise-11" id="toc-exercise-11" class="nav-link" data-scroll-target="#exercise-11"><span class="header-section-number">1.6</span> Exercise 11</a></li>
  <li><a href="#exercise-12" id="toc-exercise-12" class="nav-link" data-scroll-target="#exercise-12"><span class="header-section-number">1.7</span> Exercise 12</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Moving Beyond Linearity</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Chapter 7: ISLR2 Exercise Solutions</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Shad Ali Shah </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 10, 2026</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="chapter-7" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Chapter 7</h1>
<section id="exercise-6" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="exercise-6"><span class="header-section-number">1.1</span> Exercise 6</h2>
<div id="24eb6bc5" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np, pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.pyplot <span class="im">import</span> subplots</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.api <span class="im">import</span> OLS</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP <span class="im">import</span> load_data</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP.models <span class="im">import</span> (summarize,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>                         Stepwise,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>                         sklearn_selected,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>                         poly,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>                         ModelSpec <span class="im">as</span> MS)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.stats.anova <span class="im">import</span> anova_lm</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP.models <span class="im">import</span> sklearn_sm</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_validate, KFold</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="b348c476" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pygam <span class="im">import</span> (s <span class="im">as</span> s_gam, l <span class="im">as</span> l_gam, f <span class="im">as</span> f_gam, LinearGAM, LogisticGAM)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP.transforms <span class="im">import</span> (BSpline, NaturalSpline)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP.models <span class="im">import</span> bs, ns</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP.pygam <span class="im">import</span> (approx_lam, degrees_of_freedom, plot <span class="im">as</span> plot_gam, anova <span class="im">as</span> anova_gam)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> r2_score,mean_squared_error</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="5b8e1b20" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>Wage<span class="op">=</span>load_data(<span class="st">'Wage'</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>y<span class="op">=</span>Wage[<span class="st">'wage'</span>]</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>age<span class="op">=</span>Wage[<span class="st">'age'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="a" class="level3" data-number="1.1.1">
<h3 data-number="1.1.1" class="anchored" data-anchor-id="a"><span class="header-section-number">1.1.1</span> (a)</h3>
<p>Generally speaking it is unusual to use a polynomial degree greater than 4 because for larger degrees polynomials become overly flexible, which raises the risk of overfitting the data. For this reason we choose test the cross validation model for a maximum degree of 6.</p>
<p>The cross validation error is minimal when the polynomial degree equals 4. Now let’s use ANOVA to check the obtained result.</p>
<div id="ed35dffe" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> [MS([poly(<span class="st">'age'</span>, degree<span class="op">=</span>d)]) <span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">7</span>)]</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>Xs <span class="op">=</span> [model.fit_transform(Wage) <span class="cf">for</span> model <span class="kw">in</span> models]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>anova_lm(<span class="op">*</span>[sm.OLS(y, X_).fit() <span class="cf">for</span> X_ <span class="kw">in</span> Xs])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="84">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">df_resid</th>
<th data-quarto-table-cell-role="th">ssr</th>
<th data-quarto-table-cell-role="th">df_diff</th>
<th data-quarto-table-cell-role="th">ss_diff</th>
<th data-quarto-table-cell-role="th">F</th>
<th data-quarto-table-cell-role="th">Pr(&gt;F)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2998.0</td>
<td>5.022216e+06</td>
<td>0.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2997.0</td>
<td>4.793430e+06</td>
<td>1.0</td>
<td>228786.010128</td>
<td>143.663571</td>
<td>2.285169e-32</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2996.0</td>
<td>4.777674e+06</td>
<td>1.0</td>
<td>15755.693664</td>
<td>9.893609</td>
<td>1.674794e-03</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2995.0</td>
<td>4.771604e+06</td>
<td>1.0</td>
<td>6070.152124</td>
<td>3.811683</td>
<td>5.098933e-02</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2994.0</td>
<td>4.770322e+06</td>
<td>1.0</td>
<td>1282.563017</td>
<td>0.805371</td>
<td>3.695646e-01</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2993.0</td>
<td>4.766389e+06</td>
<td>1.0</td>
<td>3932.257665</td>
<td>2.469216</td>
<td>1.162015e-01</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The results above show that model[4] and model[5] cannot be optimal since relative p-values are already larger than 5%. On the other side we notice the best improvement for model[3] which corresponds to polynomial of degree 4. Clearly both cross-vaidation approach and ANOVA yield the same results. Now let’s plot the fitted polynomial against the data scatter. We opt to define a function which does the work as the lab did. For this function must be useful whenever we opt for another polynomial degree.</p>
<div id="3240a10c" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define a grid of 100 points over which we can compute model predictions </span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>age_grid <span class="op">=</span> np.linspace(age.<span class="bu">min</span>(), age.<span class="bu">max</span>(), <span class="dv">100</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>age_df<span class="op">=</span>pd.DataFrame({<span class="st">'age'</span>:age_grid})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="19a08b0b" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_wage_fit(age_df, basis, title):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> basis.transform(Wage)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    Xnew <span class="op">=</span> basis.transform(age_df)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> M.get_prediction(Xnew)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    bands <span class="op">=</span> preds.conf_int(alpha<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    ax.scatter(age,y,facecolor<span class="op">=</span><span class="st">'gray'</span>,alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> val, ls <span class="kw">in</span> <span class="bu">zip</span>([preds.predicted_mean,bands[:,<span class="dv">0</span>],bands[:,<span class="dv">1</span>]],[<span class="st">'b'</span>,<span class="st">'r--'</span>,<span class="st">'r--'</span>]):</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        ax.plot(age_df.values, val, ls, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    ax.set_title(title, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'Age'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Wage'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>age_df is fixed and already defined, basis will be the fitted model corresponding to polynomial of degree 4 and title can be chosen as expressive as it must be.</p>
<div id="3bffc021" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>model4<span class="op">=</span>MS([poly(<span class="st">'age'</span>, degree<span class="op">=</span><span class="dv">4</span>)]).fit(Wage)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>plot_wage_fit(age_df, model4, <span class="st">'4 degree polynomial'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-8-output-1.png" width="681" height="693" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="936aa2c5" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Perform corss validation to find the best polynomial degree</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>cv_error <span class="op">=</span> np.zeros(<span class="dv">6</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>H <span class="op">=</span> np.array(age)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> sklearn_sm(sm.OLS)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Let's introduce splits. We choose 5-folds cross validation for this example</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> KFold(n_splits<span class="op">=</span><span class="dv">5</span>,shuffle<span class="op">=</span><span class="va">True</span>,random_state<span class="op">=</span><span class="dv">0</span>) <span class="co"># The argument shuffle allows samples to overlap</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, d <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">7</span>)):</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    Xcross <span class="op">=</span> np.power.outer(H, np.arange(d<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    M_CV <span class="op">=</span> cross_validate(M,Xcross,y,cv<span class="op">=</span>cv)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    cv_error[i] <span class="op">=</span> np.mean(M_CV[<span class="st">'test_score'</span>])</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>cv_error</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="88">
<pre><code>array([1675.97797787, 1600.6843786 , 1597.00855538, 1596.20945868,
       1598.21530674, 1597.23761438])</code></pre>
</div>
</div>
</section>
<section id="b" class="level3" data-number="1.1.2">
<h3 data-number="1.1.2" class="anchored" data-anchor-id="b"><span class="header-section-number">1.1.2</span> (b)</h3>
<p>We’ll try to compare 20 models of step functions using cross validation. Each of these models correponds to a different number of cutpoints.</p>
<p>For this we’ll let the function qcut() from the pandas library automatically choose cutpoints based on quantiles.</p>
<div id="7ef9df47" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>cv_error_cuts <span class="op">=</span> np.zeros(<span class="dv">20</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, d <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">21</span>)):</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    Xcross <span class="op">=</span> pd.qcut(age, d<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    M_CV_cut <span class="op">=</span> cross_validate(M,pd.get_dummies(Xcross),y,cv<span class="op">=</span>cv)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    cv_error_cuts[i] <span class="op">=</span> np.mean(M_CV_cut[<span class="st">'test_score'</span>])</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>cv_error_cuts</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="89">
<pre><code>array([1703.98624771, 1660.21747041, 1643.54893817, 1641.65415209,
       1636.90408532, 1627.35473711, 1624.53060805, 1625.31470466,
       1619.42520284, 1622.99428956, 1622.98944769, 1616.50042257,
       1613.99483953, 1617.08432164, 1617.62667623, 1620.03577132,
       1618.02476215, 1617.60926168, 1618.28838019, 1618.78656934])</code></pre>
</div>
</div>
<p>The minimal CV error occurs when there are 12 cutpoints. We also could have chosen 8 cutpoints if there were less investigations. First, we must fit the model as the function previously defined does not take into account the modified data frame coming from splitting the age feature.</p>
<div id="51ca2911" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>n_groups<span class="op">=</span><span class="dv">12</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>cut_age <span class="op">=</span> pd.qcut(age, n_groups<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get dummy features relatively to age groups</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>dummy_age<span class="op">=</span>pd.get_dummies(cut_age)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="08fa745c" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Create a new data frame to fit the new model</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>df_step<span class="op">=</span>pd.concat([dummy_age, y], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign roles to each of the columns of the new data set and ft the model</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>Xnew<span class="op">=</span>df_step.iloc[:,:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>ynew<span class="op">=</span>df_step.iloc[:,<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>ynewnp<span class="op">=</span>np.array(ynew)[:,np.newaxis]</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>model_step<span class="op">=</span>MS(Xnew,intercept<span class="op">=</span><span class="va">False</span>).fit(df_step)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>X<span class="op">=</span>model_step.transform(df_step)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>res<span class="op">=</span>sm.OLS(ynewnp,X).fit()</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>X.shape</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="91">
<pre><code>(3000, 13)</code></pre>
</div>
</div>
<div id="b4539134" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Define a gird over which we can plot predictions. Since the ages start from 18 and end at 80</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we choose to define a grid of integer numbers through this interval</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>X_grid<span class="op">=</span>np.linspace(<span class="dv">18</span>,<span class="dv">80</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Now let's cut the defined grid over the predifined groups. We use the cut function to create an</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ordered set of values</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>groups <span class="op">=</span> pd.cut(X_grid, n_groups<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>dummies <span class="op">=</span> pd.get_dummies(groups)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>dummies.shape</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="92">
<pre><code>(50, 13)</code></pre>
</div>
</div>
<div id="03ac5609" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the function </span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>X_step <span class="op">=</span> np.linspace(<span class="dv">18</span>,<span class="dv">80</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>y_step <span class="op">=</span> res.predict(dummies)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>plt.scatter(age,y)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>plt.plot(X_step, y_step,<span class="st">'-r'</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Step function'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Age'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Wage'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="93">
<pre><code>Text(0, 0.5, 'Wage')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-14-output-2.png" width="681" height="693" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="exercise-7" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="exercise-7"><span class="header-section-number">1.2</span> Exercise 7</h2>
<div id="2379c3c0" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>Wage.info()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 3000 entries, 0 to 2999
Data columns (total 11 columns):
 #   Column      Non-Null Count  Dtype   
---  ------      --------------  -----   
 0   year        3000 non-null   int64   
 1   age         3000 non-null   int64   
 2   maritl      3000 non-null   category
 3   race        3000 non-null   category
 4   education   3000 non-null   category
 5   region      3000 non-null   category
 6   jobclass    3000 non-null   category
 7   health      3000 non-null   category
 8   health_ins  3000 non-null   category
 9   logwage     3000 non-null   float64 
 10  wage        3000 non-null   float64 
dtypes: category(7), float64(2), int64(2)
memory usage: 115.5 KB</code></pre>
</div>
</div>
<div id="537a2f20" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert both 'maritl' and 'joblcass' columns to categorical data</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>Wage[<span class="st">'maritl'</span>]<span class="op">=</span>Wage[<span class="st">'maritl'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>Wage[<span class="st">'jobclass'</span>]<span class="op">=</span>Wage[<span class="st">'jobclass'</span>].astype(<span class="st">'category'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="131b0943" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>Wage.info()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 3000 entries, 0 to 2999
Data columns (total 11 columns):
 #   Column      Non-Null Count  Dtype   
---  ------      --------------  -----   
 0   year        3000 non-null   int64   
 1   age         3000 non-null   int64   
 2   maritl      3000 non-null   category
 3   race        3000 non-null   category
 4   education   3000 non-null   category
 5   region      3000 non-null   category
 6   jobclass    3000 non-null   category
 7   health      3000 non-null   category
 8   health_ins  3000 non-null   category
 9   logwage     3000 non-null   float64 
 10  wage        3000 non-null   float64 
dtypes: category(7), float64(2), int64(2)
memory usage: 115.5 KB</code></pre>
</div>
</div>
<p>As the Wage data set contains 3000 observations, it is preferable to use distribution plots. We’ll choose to draw boxplots then to discover the relationships among ‘wage’ feature and both ‘maritl’ and ‘jobclass’.</p>
<div id="000a0443" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>Wage.boxplot(column<span class="op">=</span>[<span class="st">'wage'</span>],by<span class="op">=</span>[<span class="st">'maritl'</span>])<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-18-output-1.png" width="554" height="379" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>It seems from observing the medians that wage is highet for married people.</p>
<div id="37764d8d" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>Wage.boxplot(column<span class="op">=</span>[<span class="st">'wage'</span>],by<span class="op">=</span>[<span class="st">'jobclass'</span>])<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-19-output-1.png" width="553" height="379" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Information jobs are better paid than industrial ones.</p>
<p>Now we should explore models with and without those categorical features along with age feature through GAM. We can compare models using ANOVA_GAM.</p>
<div id="bf610920" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare three models: first model is the full model cause it contains all the three features</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># second model contains age and maritl features</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># third model contains age and jobclass features</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's fit the first model</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>gam_full <span class="op">=</span> LinearGAM(s_gam(<span class="dv">0</span>) <span class="op">+</span> f_gam(<span class="dv">1</span>, lam<span class="op">=</span><span class="dv">0</span>) <span class="op">+</span>f_gam(<span class="dv">2</span>, lam<span class="op">=</span><span class="dv">0</span>))<span class="co"># lam=0 to avoid shrinkage for categ terms</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>Xgam <span class="op">=</span> np.column_stack([age, Wage[<span class="st">'maritl'</span>].cat.codes, Wage[<span class="st">'jobclass'</span>].cat.codes])</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>gam_full <span class="op">=</span> gam_full.fit(Xgam, y)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co">#Fit the second model</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>gam_m<span class="op">=</span>LinearGAM(s_gam(<span class="dv">0</span>) <span class="op">+</span> f_gam(<span class="dv">1</span>, lam<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>gam_m <span class="op">=</span> gam_m.fit(Xgam, y)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="co">#Fit the third model</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>gam_j<span class="op">=</span>LinearGAM(s_gam(<span class="dv">0</span>) <span class="op">+</span> f_gam(<span class="dv">2</span>, lam<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>gam_j <span class="op">=</span> gam_j.fit(Xgam, y)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="9a852141" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">#compare the models</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Switch the order of arguments in anova_gam to see the difference. Basically this enables the function</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co"># to choose positive degrees of freedom for F test.</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>anova_gam(gam_j,gam_m,gam_full)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="100">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">deviance</th>
<th data-quarto-table-cell-role="th">df</th>
<th data-quarto-table-cell-role="th">deviance_diff</th>
<th data-quarto-table-cell-role="th">df_diff</th>
<th data-quarto-table-cell-role="th">F</th>
<th data-quarto-table-cell-role="th">pvalue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>116947.577099</td>
<td>2983.792999</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>117494.385017</td>
<td>2980.795863</td>
<td>-546.807919</td>
<td>2.997136</td>
<td>-4.715979</td>
<td>1.000000e+00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>115277.086317</td>
<td>2979.796157</td>
<td>2217.298700</td>
<td>0.999706</td>
<td>57.331790</td>
<td>2.530775e-07</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We find a compelling result showing that the full model, gven its pvalue, is better that the other ones.</p>
<p>In order to present the results, we draw the partial dependence plots for each of the features. For that, we assume that the three studied features are independant.</p>
<div id="f6aa084e" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Effect of age in the full model on the wage</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plot_gam(gam_full, <span class="dv">0</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Age'</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Effect on wage'</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Partial dependence of wage on age'</span>,fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-22-output-1.png" width="670" height="680" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The function is somewhat wiggly. This issue has been overcome in the lab by refitting the model along with specifiying degrees of freedom. In either cases, the tendancy of age effect on wage will be the same. It shows that the best wage is obtained at the age between 40 and approximately 45. A similar wage range can be seen at the age around 60.</p>
<div id="887444cd" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">#The following two lines are added because plot_gam function used thereafter does not proceed</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># when the categorical data to be ploted is in the middle of the matrix model</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>Xgam2 <span class="op">=</span> np.column_stack([age, Wage[<span class="st">'jobclass'</span>].cat.codes, Wage[<span class="st">'maritl'</span>].cat.codes])</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>gam_full <span class="op">=</span> gam_full.fit(Xgam2, y)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="91672f41" class="cell" data-execution_count="23">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Effect of maritl in the full model on the wage</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">12</span>))</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>ax<span class="op">=</span>plot_gam(gam_full,<span class="dv">2</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Marital status'</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Effect on wage'</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Partial dependence of wage on marital status'</span>,fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(Wage[<span class="st">'maritl'</span>].cat.categories, fontsize<span class="op">=</span><span class="dv">8</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-24-output-1.png" width="959" height="972" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We notice that the max effect on wage is obtained when the marital status is married followed by never married category. Other categories of marital satuts seem to have a positive effect on wage too, but this effect remains low.</p>
<div id="b170b755" class="cell" data-execution_count="24">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Effect of jobclass in the full model on the wage</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>ax<span class="op">=</span>plot_gam(gam_full,<span class="dv">1</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Job class'</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Effect on wage'</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Partial dependence of wage on job class'</span>,fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(Wage[<span class="st">'jobclass'</span>].cat.categories, fontsize<span class="op">=</span><span class="dv">8</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-25-output-1.png" width="659" height="677" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As predicted the effect of infomation jobs on wage is more important than the effect of industrial jobs.</p>
</section>
<section id="exercise-8" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="exercise-8"><span class="header-section-number">1.3</span> Exercise 8</h2>
<div id="e83cb615" class="cell" data-execution_count="25">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>Auto<span class="op">=</span>load_data(<span class="st">'Auto'</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>horsepower<span class="op">=</span>Auto[<span class="st">'horsepower'</span>]</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>mpg<span class="op">=</span>Auto[<span class="st">'mpg'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="09d5e95f" class="cell" data-execution_count="26">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>pd.plotting.scatter_matrix(Auto, figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">12</span>), marker <span class="op">=</span> <span class="st">'o'</span>, </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>                           hist_kwds <span class="op">=</span> {<span class="st">'bins'</span>: <span class="dv">10</span>}, s <span class="op">=</span> <span class="dv">15</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-27-output-1.png" width="969" height="961" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>In the book we analyse the behavior of mpg depending on other features. Let’s just analyze the same feature as an output.</p>
<div id="7781c1d6" class="cell" data-execution_count="27">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>Auto.corr()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="107">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mpg</th>
<th data-quarto-table-cell-role="th">cylinders</th>
<th data-quarto-table-cell-role="th">displacement</th>
<th data-quarto-table-cell-role="th">horsepower</th>
<th data-quarto-table-cell-role="th">weight</th>
<th data-quarto-table-cell-role="th">acceleration</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">origin</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">mpg</th>
<td>1.000000</td>
<td>-0.777618</td>
<td>-0.805127</td>
<td>-0.778427</td>
<td>-0.832244</td>
<td>0.423329</td>
<td>0.580541</td>
<td>0.565209</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">cylinders</th>
<td>-0.777618</td>
<td>1.000000</td>
<td>0.950823</td>
<td>0.842983</td>
<td>0.897527</td>
<td>-0.504683</td>
<td>-0.345647</td>
<td>-0.568932</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">displacement</th>
<td>-0.805127</td>
<td>0.950823</td>
<td>1.000000</td>
<td>0.897257</td>
<td>0.932994</td>
<td>-0.543800</td>
<td>-0.369855</td>
<td>-0.614535</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">horsepower</th>
<td>-0.778427</td>
<td>0.842983</td>
<td>0.897257</td>
<td>1.000000</td>
<td>0.864538</td>
<td>-0.689196</td>
<td>-0.416361</td>
<td>-0.455171</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">weight</th>
<td>-0.832244</td>
<td>0.897527</td>
<td>0.932994</td>
<td>0.864538</td>
<td>1.000000</td>
<td>-0.416839</td>
<td>-0.309120</td>
<td>-0.585005</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">acceleration</th>
<td>0.423329</td>
<td>-0.504683</td>
<td>-0.543800</td>
<td>-0.689196</td>
<td>-0.416839</td>
<td>1.000000</td>
<td>0.290316</td>
<td>0.212746</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">year</th>
<td>0.580541</td>
<td>-0.345647</td>
<td>-0.369855</td>
<td>-0.416361</td>
<td>-0.309120</td>
<td>0.290316</td>
<td>1.000000</td>
<td>0.181528</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">origin</th>
<td>0.565209</td>
<td>-0.568932</td>
<td>-0.614535</td>
<td>-0.455171</td>
<td>-0.585005</td>
<td>0.212746</td>
<td>0.181528</td>
<td>1.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>By looking at the correlation matrix and the previous pairplot, it is predictible that mpg has non linear relationships with cylinders, displacement, horsepower and weight.</p>
<p>Features seem to be highly correlated. Modelization with one predictible variable sounds a wise choice. For this we will try to regress mpg on horsepower as the previous chapters of the book did.</p>
<div id="014c675e" class="cell" data-execution_count="28">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For the polynomial regression we search the optimal degree with cross validation cv=5</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>cv_error <span class="op">=</span> np.zeros(<span class="dv">11</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>Hm <span class="op">=</span> np.array(horsepower)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> sklearn_sm(sm.OLS)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Let's introduce splits. </span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> KFold(n_splits<span class="op">=</span><span class="dv">5</span>,shuffle<span class="op">=</span><span class="va">True</span>,random_state<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, d <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">12</span>)):</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    Xcrossm <span class="op">=</span> np.power.outer(Hm, np.arange(d<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    Mat_CV <span class="op">=</span> cross_validate(M,Xcrossm,mpg,cv<span class="op">=</span>cv)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    cv_error[i] <span class="op">=</span> np.mean(Mat_CV[<span class="st">'test_score'</span>])</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>cv_error</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="108">
<pre><code>array([24.129309  , 19.16472771, 19.30299359, 19.44988803, 18.98093021,
       18.97498159, 18.88482168, 22.90576781, 23.02919884, 56.79082863,
       71.59611708])</code></pre>
</div>
</div>
<p>The cross validation error is minimal where the polynomial degree equals 7.</p>
<div id="b1761e3a" class="cell" data-execution_count="29">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define a grid of 100 points over which we can compute model predictions </span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>horse_grid <span class="op">=</span> np.linspace(horsepower.<span class="bu">min</span>(), horsepower.<span class="bu">max</span>(), <span class="dv">100</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>horse_df<span class="op">=</span>pd.DataFrame({<span class="st">'horsepower'</span>:horse_grid})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="ff602d52" class="cell" data-execution_count="30">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_mpg_fit(horse_df, basis, title):</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" Function which returns the plot of the fitted polynomial model"""</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    X1 <span class="op">=</span> basis.transform(Auto)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    Xnew1 <span class="op">=</span> basis.transform(horse_df)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> sm.OLS(mpg, X1).fit()</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> M.get_prediction(Xnew1)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    bands <span class="op">=</span> preds.conf_int(alpha<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    ax.scatter(horsepower,mpg,facecolor<span class="op">=</span><span class="st">'gray'</span>,alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> val, ls <span class="kw">in</span> <span class="bu">zip</span>([preds.predicted_mean,bands[:,<span class="dv">0</span>],bands[:,<span class="dv">1</span>]],[<span class="st">'b'</span>,<span class="st">'r--'</span>,<span class="st">'r--'</span>]):</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>        ax.plot(horse_df.values, val, ls, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    ax.set_title(title, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'Horsepower'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'mpg'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="4dc1e6e4" class="cell" data-execution_count="31">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>model7<span class="op">=</span>MS([poly(<span class="st">'horsepower'</span>, degree<span class="op">=</span><span class="dv">7</span>)]).fit(Auto)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>plot_mpg_fit(horse_df, model7, <span class="st">'7 degree polynomial'</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-32-output-1.png" width="672" height="693" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="8b45e7f5" class="cell" data-execution_count="32">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>X1 <span class="op">=</span> model7.transform(Auto)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> sm.OLS(mpg, X1).fit()</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>summarize(M)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="112">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">coef</th>
<th data-quarto-table-cell-role="th">std err</th>
<th data-quarto-table-cell-role="th">t</th>
<th data-quarto-table-cell-role="th">P&gt;|t|</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">intercept</th>
<td>23.4459</td>
<td>0.217</td>
<td>108.058</td>
<td>0.000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">poly(horsepower, degree=7)[0]</th>
<td>-120.1377</td>
<td>4.296</td>
<td>-27.966</td>
<td>0.000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">poly(horsepower, degree=7)[1]</th>
<td>44.0895</td>
<td>4.296</td>
<td>10.263</td>
<td>0.000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">poly(horsepower, degree=7)[2]</th>
<td>-3.9488</td>
<td>4.296</td>
<td>-0.919</td>
<td>0.359</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">poly(horsepower, degree=7)[3]</th>
<td>-5.1878</td>
<td>4.296</td>
<td>-1.208</td>
<td>0.228</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">poly(horsepower, degree=7)[4]</th>
<td>13.2722</td>
<td>4.296</td>
<td>3.089</td>
<td>0.002</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">poly(horsepower, degree=7)[5]</th>
<td>-8.5462</td>
<td>4.296</td>
<td>-1.989</td>
<td>0.047</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">poly(horsepower, degree=7)[6]</th>
<td>7.9806</td>
<td>4.296</td>
<td>1.858</td>
<td>0.064</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We notice that pvalue of degree 7 is not sigificant and the graph is wiggly. This implies that the best polynomial model has 6 degrees, which means that we have to refit the model using the same approach as above.</p>
<div id="a69b1700" class="cell" data-execution_count="33">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step function model. First, let's try to find the optimal number of cuts</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co">#We'll use for that cross validation approach</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>cv_error_cuts <span class="op">=</span> np.zeros(<span class="dv">20</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, d <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">21</span>)):</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    Xcross <span class="op">=</span> pd.qcut(horsepower, d<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    M_CV_cut <span class="op">=</span> cross_validate(sklearn_sm(sm.OLS),pd.get_dummies(Xcross),mpg,cv<span class="op">=</span>cv)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    cv_error_cuts[i] <span class="op">=</span> np.mean(M_CV_cut[<span class="st">'test_score'</span>])</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>cv_error_cuts</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="113">
<pre><code>array([29.82444399, 23.41049429, 20.26054905, 20.94466903, 18.9431238 ,
       19.74372876, 18.83251652, 18.69517885, 19.38914021, 18.70211447,
       17.9802214 , 19.46457473, 19.12644741, 19.03149541, 18.25730498,
       19.42660673, 19.07914753, 19.26482791, 18.92616421, 20.80317346])</code></pre>
</div>
</div>
<p>We deduce from the minimum cross validation error that the best number of cuts is 10.</p>
<div id="32030fb8" class="cell" data-execution_count="34">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>n_cuts<span class="op">=</span><span class="dv">10</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>cut_horse <span class="op">=</span> pd.qcut(horsepower, n_cuts<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get dummy features relatively to horsepower groups</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>dummy_horse<span class="op">=</span>pd.get_dummies(cut_horse)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Create a new data frame to fit the new model</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>dfh_step<span class="op">=</span>pd.concat([dummy_horse, mpg], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign roles to each of the columns of the new data set and ft the model</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>Xnewh<span class="op">=</span>dfh_step.iloc[:,:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>ynewh<span class="op">=</span>dfh_step.iloc[:,<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>ynewhnp<span class="op">=</span>np.array(ynewh)[:,np.newaxis]</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>modelh_step<span class="op">=</span>MS(Xnewh,intercept<span class="op">=</span><span class="va">False</span>).fit(dfh_step)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>Xh<span class="op">=</span>modelh_step.transform(dfh_step)</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>resh<span class="op">=</span>sm.OLS(ynewhnp,Xh).fit()</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="co">#Define a gird over which we can plot predictions</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>Xh_grid<span class="op">=</span>np.linspace(horsepower.<span class="bu">min</span>(),horsepower.<span class="bu">max</span>())</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="co">#Now let's cut the defined grid over the predifined groups. We use the cut function to create an</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a><span class="co"># ordered set of values</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>groupsh <span class="op">=</span> pd.cut(Xh_grid, n_cuts<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>dummiesh <span class="op">=</span> pd.get_dummies(groupsh)</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the step function </span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>yh_step <span class="op">=</span> resh.predict(dummiesh)</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>plt.scatter(horsepower,mpg)</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>plt.plot(Xh_grid, yh_step,<span class="st">'-r'</span>)</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Step function'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Horsepower'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'mpg'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-35-output-1.png" width="672" height="693" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="473171da" class="cell" data-execution_count="35">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>summarize(resh)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="115">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">coef</th>
<th data-quarto-table-cell-role="th">std err</th>
<th data-quarto-table-cell-role="th">t</th>
<th data-quarto-table-cell-role="th">P&gt;|t|</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">(45.999, 65.0]</th>
<td>34.3243</td>
<td>0.701</td>
<td>48.982</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">(65.0, 71.0]</th>
<td>32.4462</td>
<td>0.683</td>
<td>47.537</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">(71.0, 78.0]</th>
<td>27.9235</td>
<td>0.731</td>
<td>38.198</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">(78.0, 86.0]</th>
<td>26.6583</td>
<td>0.710</td>
<td>37.525</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">(86.0, 90.0]</th>
<td>24.6452</td>
<td>0.658</td>
<td>37.471</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">(90.0, 96.273]</th>
<td>24.0346</td>
<td>0.836</td>
<td>28.751</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">(96.273, 105.0]</th>
<td>20.4524</td>
<td>0.658</td>
<td>31.096</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">(105.0, 115.364]</th>
<td>20.8862</td>
<td>0.792</td>
<td>26.387</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">(115.364, 145.0]</th>
<td>17.3553</td>
<td>0.691</td>
<td>25.099</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">(145.0, 165.0]</th>
<td>14.5722</td>
<td>0.710</td>
<td>20.512</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">(165.0, 230.0]</th>
<td>13.2576</td>
<td>0.742</td>
<td>17.867</td>
<td>0.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Obviously the step function looks wiggly. The polynomial regression seems to fit better the training model.</p>
<div id="288a7cf5" class="cell" data-execution_count="36">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Natural cubic spline model. We could have used cross validation to determine the degrees of freedom.</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co"># But we assume here, as it is often the case, that there must be 6 since a cubic spline implies </span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 degrees along with 2 more constraints to add at the ends.</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>ns_horse <span class="op">=</span> MS([ns(<span class="st">'horsepower'</span>, df<span class="op">=</span><span class="dv">6</span>)]).fit(Auto)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>M_nsh <span class="op">=</span> sm.OLS(mpg, ns_horse.transform(Auto)).fit()</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>summarize(M_nsh)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="116">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">coef</th>
<th data-quarto-table-cell-role="th">std err</th>
<th data-quarto-table-cell-role="th">t</th>
<th data-quarto-table-cell-role="th">P&gt;|t|</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">intercept</th>
<td>34.7379</td>
<td>1.509</td>
<td>23.021</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ns(horsepower, df=6)[0]</th>
<td>-8.2104</td>
<td>1.594</td>
<td>-5.149</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">ns(horsepower, df=6)[1]</th>
<td>-13.0459</td>
<td>1.835</td>
<td>-7.108</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ns(horsepower, df=6)[2]</th>
<td>-14.5766</td>
<td>1.886</td>
<td>-7.730</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">ns(horsepower, df=6)[3]</th>
<td>-22.8020</td>
<td>1.624</td>
<td>-14.039</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ns(horsepower, df=6)[4]</th>
<td>-22.7577</td>
<td>3.512</td>
<td>-6.480</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">ns(horsepower, df=6)[5]</th>
<td>-20.8492</td>
<td>1.742</td>
<td>-11.967</td>
<td>0.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="0de65a42" class="cell" data-execution_count="37">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>plot_mpg_fit(horse_df, ns_horse,<span class="st">'Natural spline, df=6'</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-38-output-1.png" width="672" height="693" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>All the coefficients are significant and the confidence intervals plots at the ends look stable.</p>
</section>
<section id="exercise-9" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="exercise-9"><span class="header-section-number">1.4</span> Exercise 9</h2>
<div id="26260086" class="cell" data-execution_count="38">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>Boston<span class="op">=</span>load_data(<span class="st">'Boston'</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>dis<span class="op">=</span>Boston[<span class="st">'dis'</span>]</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>nox<span class="op">=</span>Boston[<span class="st">'nox'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="a-1" class="level3" data-number="1.4.1">
<h3 data-number="1.4.1" class="anchored" data-anchor-id="a-1"><span class="header-section-number">1.4.1</span> (a)</h3>
<div id="3f6f20fe" class="cell" data-execution_count="39">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>model3<span class="op">=</span>MS([poly(<span class="st">'dis'</span>, degree<span class="op">=</span><span class="dv">3</span>)]).fit(Boston)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>X<span class="op">=</span>model3.transform(Boston)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>res<span class="op">=</span>sm.OLS(nox, X).fit()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="aff461a8" class="cell" data-execution_count="40">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>summarize(res)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="120">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">coef</th>
<th data-quarto-table-cell-role="th">std err</th>
<th data-quarto-table-cell-role="th">t</th>
<th data-quarto-table-cell-role="th">P&gt;|t|</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">intercept</th>
<td>0.5547</td>
<td>0.003</td>
<td>201.021</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">poly(dis, degree=3)[0]</th>
<td>-2.0031</td>
<td>0.062</td>
<td>-32.271</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">poly(dis, degree=3)[1]</th>
<td>0.8563</td>
<td>0.062</td>
<td>13.796</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">poly(dis, degree=3)[2]</th>
<td>-0.3180</td>
<td>0.062</td>
<td>-5.124</td>
<td>0.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="4417b9e1" class="cell" data-execution_count="41">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Define the grid of predictor values</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>dis_grid <span class="op">=</span> np.linspace(dis.<span class="bu">min</span>(), dis.<span class="bu">max</span>(), <span class="dv">100</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>dis_df<span class="op">=</span>pd.DataFrame({<span class="st">'dis'</span>:dis_grid})</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>dis2_df<span class="op">=</span>pd.DataFrame({<span class="st">'dis'</span>:dis})</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Plot the results</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>Xnew2<span class="op">=</span>model3.transform(dis_df)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> res.get_prediction(Xnew2)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>bands <span class="op">=</span> preds.conf_int(alpha<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>ax.scatter(dis,nox,facecolor<span class="op">=</span><span class="st">'gray'</span>,alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> val, ls <span class="kw">in</span> <span class="bu">zip</span>([preds.predicted_mean,bands[:,<span class="dv">0</span>],bands[:,<span class="dv">1</span>]],[<span class="st">'b'</span>,<span class="st">'r--'</span>,<span class="st">'r--'</span>]):</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>        ax.plot(dis_df.values, val, ls, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Cubic polynomial regression of nox on dis'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'dis'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'nox'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-42-output-1.png" width="676" height="693" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="43d8cac1" class="cell" data-execution_count="42">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>preds<span class="op">=</span>preds.predicted_mean.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>preds.shape</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="122">
<pre><code>(100, 1)</code></pre>
</div>
</div>
</section>
<section id="b-1" class="level3" data-number="1.4.2">
<h3 data-number="1.4.2" class="anchored" data-anchor-id="b-1"><span class="header-section-number">1.4.2</span> (b)</h3>
<div id="bb41d480" class="cell" data-execution_count="43">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>RSS<span class="op">=</span>{}</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">11</span>):</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>MS([poly(<span class="st">'dis'</span>, degree<span class="op">=</span>d)]).fit(Boston)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    X<span class="op">=</span>model.transform(Boston)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    res<span class="op">=</span>sm.OLS(nox, X).fit()</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    Xnew<span class="op">=</span>model.transform(dis_df)</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    Xnew2<span class="op">=</span>model.transform(dis2_df)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> res.get_prediction(Xnew)</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    yhat<span class="op">=</span>res.get_prediction(Xnew2)</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    yhat<span class="op">=</span>yhat.predicted_mean</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    RSS[d]<span class="op">=</span>np.<span class="bu">sum</span>((nox <span class="op">-</span> yhat)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>    ax.scatter(dis,nox,facecolor<span class="op">=</span><span class="st">'gray'</span>,alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>    ax.plot(dis_df.values,preds.predicted_mean , <span class="st">'b'</span>, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Polynomial regression of nox on dis with degree='</span><span class="op">+</span> <span class="bu">str</span>(d), fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'dis'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'nox'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-44-output-1.png" width="718" height="693" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-44-output-2.png" width="718" height="693" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-44-output-3.png" width="718" height="693" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-44-output-4.png" width="718" height="693" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-44-output-5.png" width="718" height="693" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-44-output-6.png" width="718" height="693" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-44-output-7.png" width="718" height="693" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-44-output-8.png" width="718" height="693" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-44-output-9.png" width="718" height="693" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-44-output-10.png" width="726" height="693" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="90515c9d" class="cell" data-execution_count="44">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(RSS,index <span class="op">=</span> [<span class="st">'RSS'</span>]).T</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="124">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">RSS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1</th>
<td>2.768563</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2</th>
<td>2.035262</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3</th>
<td>1.934107</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">4</th>
<td>1.932981</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">5</th>
<td>1.915290</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">6</th>
<td>1.878257</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">7</th>
<td>1.849484</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">8</th>
<td>1.835630</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">9</th>
<td>1.833331</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">10</th>
<td>1.832171</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>As expected, the training RSE decreases with the polynomial degree.</p>
</section>
<section id="c" class="level3" data-number="1.4.3">
<h3 data-number="1.4.3" class="anchored" data-anchor-id="c"><span class="header-section-number">1.4.3</span> (c)</h3>
<div id="4f9734d2" class="cell" data-execution_count="45">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using cross validation to find the best polynomial degree. cv=5</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>cv_error <span class="op">=</span> np.zeros(<span class="dv">11</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>H <span class="op">=</span> np.array(dis)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> sklearn_sm(sm.OLS)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Let's introduce splits. </span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> KFold(n_splits<span class="op">=</span><span class="dv">5</span>,shuffle<span class="op">=</span><span class="va">True</span>,random_state<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, d <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">12</span>)):</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    Xcross <span class="op">=</span> np.power.outer(H, np.arange(d<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    Mat_CV <span class="op">=</span> cross_validate(M,Xcross,nox,cv<span class="op">=</span>cv)</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    cv_error[i] <span class="op">=</span> np.mean(Mat_CV[<span class="st">'test_score'</span>])</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>cv_error</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="125">
<pre><code>array([0.00550455, 0.00404589, 0.00384482, 0.00385288, 0.00405327,
       0.00490166, 0.00711742, 0.0065405 , 0.02188363, 0.00468506,
       0.05257292])</code></pre>
</div>
</div>
<p>The optimal polynomial regression is obtained for 3 degrees.</p>
</section>
<section id="d" class="level3" data-number="1.4.4">
<h3 data-number="1.4.4" class="anchored" data-anchor-id="d"><span class="header-section-number">1.4.4</span> (d)</h3>
<div id="eddb3ad5" class="cell" data-execution_count="46">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>bs_dis <span class="op">=</span> MS([bs(<span class="st">'dis'</span>, df<span class="op">=</span><span class="dv">4</span>)]).fit(Boston)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>M_bs <span class="op">=</span> sm.OLS(nox, bs_dis.transform(Boston)).fit()</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>summarize(M_bs)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="126">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">coef</th>
<th data-quarto-table-cell-role="th">std err</th>
<th data-quarto-table-cell-role="th">t</th>
<th data-quarto-table-cell-role="th">P&gt;|t|</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">intercept</th>
<td>0.7345</td>
<td>0.015</td>
<td>50.306</td>
<td>0.000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">bs(dis, df=4)[0]</th>
<td>-0.0581</td>
<td>0.022</td>
<td>-2.658</td>
<td>0.008</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">bs(dis, df=4)[1]</th>
<td>-0.4636</td>
<td>0.024</td>
<td>-19.596</td>
<td>0.000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">bs(dis, df=4)[2]</th>
<td>-0.1998</td>
<td>0.043</td>
<td>-4.634</td>
<td>0.000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">bs(dis, df=4)[3]</th>
<td>-0.3888</td>
<td>0.046</td>
<td>-8.544</td>
<td>0.000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="4aa5a770" class="cell" data-execution_count="47">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> bs_dis.transform(Boston)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>Xnew <span class="op">=</span> bs_dis.transform(dis_df)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> sm.OLS(nox, X).fit()</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> M.get_prediction(Xnew)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>bands <span class="op">=</span> preds.conf_int(alpha<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>ax.scatter(dis,nox,facecolor<span class="op">=</span><span class="st">'gray'</span>,alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> val, ls <span class="kw">in</span> <span class="bu">zip</span>([preds.predicted_mean,bands[:,<span class="dv">0</span>],bands[:,<span class="dv">1</span>]],[<span class="st">'b'</span>,<span class="st">'r--'</span>,<span class="st">'r--'</span>]):</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>        ax.plot(dis_df.values, val, ls, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Regression spline fit of nox on dis with 4 df'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'dis'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'nox'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-48-output-1.png" width="676" height="693" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The knots were automatically chosen as the four quartiles.</p>
</section>
<section id="e" class="level3" data-number="1.4.5">
<h3 data-number="1.4.5" class="anchored" data-anchor-id="e"><span class="header-section-number">1.4.5</span> (e)</h3>
<div id="4a635ca3" class="cell" data-execution_count="48">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>RSS<span class="op">=</span>{}</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>,<span class="dv">11</span>):</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    bs_dis <span class="op">=</span> MS([bs(<span class="st">'dis'</span>, df<span class="op">=</span>d)]).fit(Boston)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    M_bs <span class="op">=</span> sm.OLS(nox, bs_dis.transform(Boston)).fit()</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    Xnew <span class="op">=</span> bs_dis.transform(dis_df)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    Xnew2<span class="op">=</span>bs_dis.transform(dis2_df)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> M_bs.get_prediction(Xnew)</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    yhat<span class="op">=</span>M_bs.get_prediction(Xnew2)</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    yhat<span class="op">=</span>yhat.predicted_mean</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    RSS[d]<span class="op">=</span>np.<span class="bu">sum</span>((nox <span class="op">-</span> yhat)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>    bands <span class="op">=</span> preds.conf_int(alpha<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>    ax.scatter(dis,nox,facecolor<span class="op">=</span><span class="st">'gray'</span>,alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>    ax.plot(dis_df.values, preds.predicted_mean, <span class="st">'b'</span>, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Regression spline fit of nox on dis with df='</span><span class="op">+</span><span class="bu">str</span>(d), fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'dis'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'nox'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-49-output-1.png" width="676" height="693" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-49-output-2.png" width="676" height="693" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-49-output-3.png" width="676" height="693" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-49-output-4.png" width="676" height="693" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-49-output-5.png" width="676" height="693" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-49-output-6.png" width="676" height="693" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-49-output-7.png" width="676" height="693" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-49-output-8.png" width="681" height="693" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="0bbb849e" class="cell" data-execution_count="49">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(RSS,index <span class="op">=</span> [<span class="st">'RSS'</span>]).T</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="129">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">RSS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">3</th>
<td>1.934107</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">4</th>
<td>1.922775</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">5</th>
<td>1.840173</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">6</th>
<td>1.833966</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">7</th>
<td>1.829884</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">8</th>
<td>1.816995</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">9</th>
<td>1.825653</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">10</th>
<td>1.792535</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The training RSS decreases with degrees of freedom. We cannot decide which is the best regression spline model.</p>
</section>
<section id="f" class="level3" data-number="1.4.6">
<h3 data-number="1.4.6" class="anchored" data-anchor-id="f"><span class="header-section-number">1.4.6</span> (f)</h3>
<div id="73e576c6" class="cell" data-execution_count="50">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using cross validation to find the best regression spline model. cv=10</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>cv_error <span class="op">=</span> np.zeros(<span class="dv">9</span>)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> sklearn_sm(sm.OLS)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> KFold(n_splits<span class="op">=</span><span class="dv">10</span>,shuffle<span class="op">=</span><span class="va">True</span>,random_state<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>,<span class="dv">12</span>):</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    bs_dis <span class="op">=</span> MS([bs(<span class="st">'dis'</span>, df<span class="op">=</span>d)]).fit(Boston)</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>    Xcross <span class="op">=</span> bs_dis.transform(Boston)</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    Mat_CV <span class="op">=</span> cross_validate(M,Xcross,nox,cv<span class="op">=</span>cv)</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>    cv_error[d<span class="op">-</span><span class="dv">3</span>] <span class="op">=</span> np.mean(Mat_CV[<span class="st">'test_score'</span>])</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>cv_error</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="130">
<pre><code>array([0.00387002, 0.00388453, 0.0037093 , 0.0037177 , 0.00372454,
       0.00371579, 0.00375893, 0.00371381, 0.00373558])</code></pre>
</div>
</div>
<p>The optimal model is obtained for 5 degrees of freedom but results seem unstable. Another approach like ANOVA can be more useful to spot the best model.</p>
</section>
</section>
<section id="exercise-10" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="exercise-10"><span class="header-section-number">1.5</span> Exercise 10</h2>
<div id="8bfa9a17" class="cell" data-execution_count="51">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>College<span class="op">=</span>load_data(<span class="st">'College'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="a-2" class="level3" data-number="1.5.1">
<h3 data-number="1.5.1" class="anchored" data-anchor-id="a-2"><span class="header-section-number">1.5.1</span> (a)</h3>
<div id="87633405" class="cell" data-execution_count="52">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>College_train, College_valid <span class="op">=</span> train_test_split(College, test_size<span class="op">=</span><span class="fl">0.5</span>, random_state<span class="op">=</span><span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="e1445ada" class="cell" data-execution_count="53">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>College[<span class="st">'Private'</span>]<span class="op">=</span>College[<span class="st">'Private'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>College_train[<span class="st">'Private'</span>]<span class="op">=</span>College_train[<span class="st">'Private'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>College_valid[<span class="st">'Private'</span>]<span class="op">=</span>College_valid[<span class="st">'Private'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>y<span class="op">=</span>College_train[<span class="st">'Outstate'</span>]</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>Vars_train <span class="op">=</span> College_train.columns.drop([<span class="st">'Outstate'</span>])</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>design<span class="op">=</span>MS(Vars_train).fit(College_train)</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>X_train<span class="op">=</span>design.transform(College_train)</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>College_train.info()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
Index: 388 entries, 54 to 684
Data columns (total 18 columns):
 #   Column       Non-Null Count  Dtype   
---  ------       --------------  -----   
 0   Private      388 non-null    category
 1   Apps         388 non-null    int64   
 2   Accept       388 non-null    int64   
 3   Enroll       388 non-null    int64   
 4   Top10perc    388 non-null    int64   
 5   Top25perc    388 non-null    int64   
 6   F.Undergrad  388 non-null    int64   
 7   P.Undergrad  388 non-null    int64   
 8   Outstate     388 non-null    int64   
 9   Room.Board   388 non-null    int64   
 10  Books        388 non-null    int64   
 11  Personal     388 non-null    int64   
 12  PhD          388 non-null    int64   
 13  Terminal     388 non-null    int64   
 14  S.F.Ratio    388 non-null    float64 
 15  perc.alumni  388 non-null    int64   
 16  Expend       388 non-null    int64   
 17  Grad.Rate    388 non-null    int64   
dtypes: category(1), float64(1), int64(16)
memory usage: 55.1 KB</code></pre>
</div>
</div>
<div id="b60a6ba9" class="cell" data-execution_count="54">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the scoring system based on Cp coefficient</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> nCp(sigma2, estimator, X, Y):</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Negative Cp statistic"</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    n, p <span class="op">=</span> X.shape</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    Yhat <span class="op">=</span> estimator.predict(X)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    RSS <span class="op">=</span> np.<span class="bu">sum</span>((Y <span class="op">-</span> Yhat)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>(RSS <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> p <span class="op">*</span> sigma2) <span class="op">/</span> n </span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>design_sigma <span class="op">=</span> MS(College.columns.drop(<span class="st">'Outstate'</span>)).fit(College)</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>Y_sigma <span class="op">=</span> np.array(College[<span class="st">'Outstate'</span>])</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>X_sigma <span class="op">=</span> design_sigma.transform(College)</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>sigma2 <span class="op">=</span> OLS(Y_sigma,X_sigma).fit().scale</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>neg_Cp <span class="op">=</span> partial(nCp, sigma2)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="50834d8e" class="cell" data-execution_count="55">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>strategy<span class="op">=</span>Stepwise.first_peak(design,direction<span class="op">=</span><span class="st">'forward'</span>,max_terms<span class="op">=</span><span class="bu">len</span>(design.terms))</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>Outstate_MSE <span class="op">=</span> sklearn_selected(OLS,strategy,scoring<span class="op">=</span>neg_Cp)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>Outstate_MSE.fit(College_train, y)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>Outstate_MSE.selected_state_</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="135">
<pre><code>('Accept',
 'Expend',
 'F.Undergrad',
 'Grad.Rate',
 'Personal',
 'Private',
 'Room.Board',
 'Terminal',
 'Top10perc',
 'perc.alumni')</code></pre>
</div>
</div>
<p>The optimization of Cp coefficient shows that the best model obtained by forward stepwise selection relies on 10 predictors.</p>
</section>
<section id="b-2" class="level3" data-number="1.5.2">
<h3 data-number="1.5.2" class="anchored" data-anchor-id="b-2"><span class="header-section-number">1.5.2</span> (b)</h3>
<div id="e33885c3" class="cell" data-execution_count="56">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>gam <span class="op">=</span> LinearGAM(s_gam(<span class="dv">0</span>)<span class="op">+</span> s_gam(<span class="dv">1</span>)<span class="op">+</span>s_gam(<span class="dv">2</span>)<span class="op">+</span>s_gam(<span class="dv">3</span>)<span class="op">+</span>s_gam(<span class="dv">4</span>)<span class="op">+</span> f_gam(<span class="dv">5</span>, lam<span class="op">=</span><span class="dv">0</span>) </span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>                <span class="op">+</span>s_gam(<span class="dv">6</span>)<span class="op">+</span>s_gam(<span class="dv">7</span>)<span class="op">+</span>s_gam(<span class="dv">8</span>)<span class="op">+</span>s_gam(<span class="dv">9</span>))</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>Xgam <span class="op">=</span> np.column_stack([College_train[<span class="st">'Accept'</span>],College_train[<span class="st">'Expend'</span>],College_train[<span class="st">'F.Undergrad'</span>],College_train[<span class="st">'Grad.Rate'</span>],</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>                        College_train[<span class="st">'Personal'</span>], College_train[<span class="st">'Private'</span>].cat.codes,College_train[<span class="st">'Room.Board'</span>],</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>                        College_train[<span class="st">'Terminal'</span>],College_train[<span class="st">'Top10perc'</span>],College_train[<span class="st">'perc.alumni'</span>]])</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>gam <span class="op">=</span> gam.fit(Xgam, y)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="aea21a36" class="cell" data-execution_count="57">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> d <span class="kw">in</span> Outstate_MSE.selected_state_:</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>    i<span class="op">=</span>Outstate_MSE.selected_state_.index(d)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> plot_gam(gam, i)</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(d)</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Effect on Outstate tuition'</span>)</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Partial dependence of Outstate tuition on '</span><span class="op">+</span>d,fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-58-output-1.png" width="715" height="680" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-58-output-2.png" width="720" height="680" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-58-output-3.png" width="750" height="680" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-58-output-4.png" width="737" height="680" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-58-output-5.png" width="727" height="680" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-58-output-6.png" width="705" height="680" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-58-output-7.png" width="751" height="680" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-58-output-8.png" width="726" height="680" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-58-output-9.png" width="739" height="680" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-58-output-10.png" width="749" height="680" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Some of the graphs represented above display wiggly splines (e.g Outstate tuition on Terminal) which puts the gam model considered before into question. In order to select the best GAM model we should consider the aformentionned cases and alternate between linear spline choices. The comparison of obtained models can be done using ANOVA</p>
<p>We choose to experiment with the following features due the roughness of their splines shown on the previous graphs: ‘perc.alumni’, ‘Room.Board’ and ‘Grad.Rate’.</p>
<div id="cc493395" class="cell" data-execution_count="58">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>gam2 <span class="op">=</span> LinearGAM(s_gam(<span class="dv">0</span>)<span class="op">+</span> s_gam(<span class="dv">1</span>)<span class="op">+</span>s_gam(<span class="dv">2</span>)<span class="op">+</span>l_gam(<span class="dv">3</span>)<span class="op">+</span>s_gam(<span class="dv">4</span>)<span class="op">+</span> f_gam(<span class="dv">5</span>, lam<span class="op">=</span><span class="dv">0</span>) </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>                <span class="op">+</span>l_gam(<span class="dv">6</span>)<span class="op">+</span>s_gam(<span class="dv">7</span>)<span class="op">+</span>s_gam(<span class="dv">8</span>)<span class="op">+</span>l_gam(<span class="dv">9</span>))</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>gam2 <span class="op">=</span> gam2.fit(Xgam, y)</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>anova_gam(gam2,gam)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="138">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">deviance</th>
<th data-quarto-table-cell-role="th">df</th>
<th data-quarto-table-cell-role="th">deviance_diff</th>
<th data-quarto-table-cell-role="th">df_diff</th>
<th data-quarto-table-cell-role="th">F</th>
<th data-quarto-table-cell-role="th">pvalue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>605806.774706</td>
<td>331.378505</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>547527.330268</td>
<td>304.809671</td>
<td>58279.444439</td>
<td>26.568834</td>
<td>1.221141</td>
<td>0.24335</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The above table shows that ‘gam’ model is no better than the second. Hence gam2 is adopted for the rest of the exercise.</p>
</section>
<section id="c-1" class="level3" data-number="1.5.3">
<h3 data-number="1.5.3" class="anchored" data-anchor-id="c-1"><span class="header-section-number">1.5.3</span> (c)</h3>
<div id="537d5e68" class="cell" data-execution_count="59">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>y_test<span class="op">=</span>College_valid[<span class="st">'Outstate'</span>]</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="co">#vars_test=College_valid.columns.drop(['Outstate'])</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="co">#design_test=MS(vars_test).fit(College_valid)</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="co">#X_test=design.transform(College_valid)</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> np.column_stack([College_valid[<span class="st">'Accept'</span>],College_valid[<span class="st">'Expend'</span>],</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>                          College_valid[<span class="st">'F.Undergrad'</span>],College_valid[<span class="st">'Grad.Rate'</span>],</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>                        College_valid[<span class="st">'Personal'</span>], </span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>                          College_valid[<span class="st">'Private'</span>].cat.codes,College_valid[<span class="st">'Room.Board'</span>],</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>                        College_valid[<span class="st">'Terminal'</span>],College_valid[<span class="st">'Top10perc'</span>],</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>                          College_valid[<span class="st">'perc.alumni'</span>]])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="6d0bb836" class="cell" data-execution_count="60">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>test_preds<span class="op">=</span>gam2.predict(X_test)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>r2_score(y_test,test_preds)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="140">
<pre><code>0.7978553110280047</code></pre>
</div>
</div>
<p>The <span class="math inline">\(R^2\)</span> metric is nearly 80%, which is a sign of good fit.</p>
</section>
<section id="d-1" class="level3" data-number="1.5.4">
<h3 data-number="1.5.4" class="anchored" data-anchor-id="d-1"><span class="header-section-number">1.5.4</span> (d)</h3>
<div id="290da355" class="cell" data-execution_count="61">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>gam.summary()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>LinearGAM                                                                                                 
=============================================== ==========================================================
Distribution:                        NormalDist Effective DoF:                                     83.1903
Link Function:                     IdentityLink Log Likelihood:                                 -3416.4233
Number of Samples:                          388 AIC:                                             7001.2272
                                                AICc:                                            7048.5982
                                                GCV:                                          5175682.4843
                                                Scale:                                           1796.2925
                                                Pseudo R-Squared:                                   0.8459
==========================================================================================================
Feature Function                  Lambda               Rank         EDoF         P &gt; x        Sig. Code   
================================= ==================== ============ ============ ============ ============
s(0)                              [0.6]                20           11.5         3.57e-06     ***         
s(1)                              [0.6]                20           8.9          4.17e-08     ***         
s(2)                              [0.6]                20           9.6          4.64e-07     ***         
s(3)                              [0.6]                20           10.8         1.64e-01                 
s(4)                              [0.6]                20           8.2          1.66e-01                 
f(5)                              [0]                  2            0.9          7.74e-06     ***         
s(6)                              [0.6]                20           9.8          1.37e-02     *           
s(7)                              [0.6]                20           8.8          4.89e-01                 
s(8)                              [0.6]                20           7.9          5.73e-01                 
s(9)                              [0.6]                20           6.7          5.11e-02     .           
intercept                                              1            0.0          1.11e-16     ***         
==========================================================================================================
Significance codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

WARNING: Fitting splines and a linear function to a feature introduces a model identifiability problem
         which can cause p-values to appear significant when they are not.

WARNING: p-values calculated in this manner behave correctly for un-penalized models or models with
         known smoothing parameters, but when smoothing parameters have been estimated, the p-values
         are typically lower than they should be, meaning that the tests reject the null too readily.</code></pre>
</div>
</div>
<div id="80e767f4" class="cell" data-execution_count="62">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>gam2.summary()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>LinearGAM                                                                                                 
=============================================== ==========================================================
Distribution:                        NormalDist Effective DoF:                                     56.6215
Link Function:                     IdentityLink Log Likelihood:                                 -3436.5268
Number of Samples:                          388 AIC:                                             6988.2966
                                                AICc:                                            7008.8071
                                                GCV:                                          4508356.3536
                                                Scale:                                           1828.1414
                                                Pseudo R-Squared:                                   0.8265
==========================================================================================================
Feature Function                  Lambda               Rank         EDoF         P &gt; x        Sig. Code   
================================= ==================== ============ ============ ============ ============
s(0)                              [0.6]                20           11.0         1.15e-05     ***         
s(1)                              [0.6]                20           7.9          6.30e-09     ***         
s(2)                              [0.6]                20           8.9          2.61e-06     ***         
l(3)                              [0.6]                1            0.9          1.26e-01                 
s(4)                              [0.6]                20           7.9          1.46e-01                 
f(5)                              [0]                  2            0.9          1.62e-06     ***         
l(6)                              [0.6]                1            0.9          2.84e-05     ***         
s(7)                              [0.6]                20           9.5          5.72e-01                 
s(8)                              [0.6]                20           8.0          7.46e-01                 
l(9)                              [0.6]                1            0.8          2.40e-05     ***         
intercept                                              1            0.0          7.70e-09     ***         
==========================================================================================================
Significance codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

WARNING: Fitting splines and a linear function to a feature introduces a model identifiability problem
         which can cause p-values to appear significant when they are not.

WARNING: p-values calculated in this manner behave correctly for un-penalized models or models with
         known smoothing parameters, but when smoothing parameters have been estimated, the p-values
         are typically lower than they should be, meaning that the tests reject the null too readily.</code></pre>
</div>
</div>
<p>Using stepwise forward selection was a bad idea. The number of observations seem insufficient to bring stable results. Splitting the already small dataset made things worse (Steyerberg et al.&nbsp;show that there must be at least 50 observations per feature to have acceptable results using stepwise selection. See : Prognostic modeling with logistic regression analysis: in search of a sensible strategy in small data sets. ). pvalues don’t reflect the correct values and hence are not reliable. In a more realistic case we should avoid stepwise selection and opt for other approaches for feature selection like ridge regression.</p>
</section>
</section>
<section id="exercise-11" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="exercise-11"><span class="header-section-number">1.6</span> Exercise 11</h2>
<section id="a-3" class="level3" data-number="1.6.1">
<h3 data-number="1.6.1" class="anchored" data-anchor-id="a-3"><span class="header-section-number">1.6.1</span> (a)</h3>
<div id="84b22b55" class="cell" data-execution_count="63">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>n<span class="op">=</span><span class="dv">100</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">12</span>)</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>X1<span class="op">=</span>np.random.randn(n)</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>X2<span class="op">=</span>np.random.randn(n)</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>epsilon<span class="op">=</span>np.random.randn(n)</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>beta<span class="op">=</span>[<span class="fl">0.5</span>,<span class="dv">1</span>,<span class="fl">1.5</span>]</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>Y<span class="op">=</span>beta[<span class="dv">0</span>]<span class="op">+</span>beta[<span class="dv">1</span>]<span class="op">*</span>X1<span class="op">+</span>beta[<span class="dv">2</span>]<span class="op">*</span>X2<span class="op">+</span>epsilon</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="b-3" class="level3" data-number="1.6.2">
<h3 data-number="1.6.2" class="anchored" data-anchor-id="b-3"><span class="header-section-number">1.6.2</span> (b)</h3>
<div id="f4ef0e23" class="cell" data-execution_count="64">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> simple_reg(outcome,feature):</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>    df<span class="op">=</span>pd.DataFrame({<span class="st">'outcome'</span>:outcome,<span class="st">'feature'</span>:feature})</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    design<span class="op">=</span>MS([<span class="st">'feature'</span>])</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    X<span class="op">=</span>design.fit_transform(df)</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>sm.OLS(outcome,X)</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>    result<span class="op">=</span>model.fit()</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result.params[<span class="dv">0</span>],result.params[<span class="dv">1</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="c-2" class="level3" data-number="1.6.3">
<h3 data-number="1.6.3" class="anchored" data-anchor-id="c-2"><span class="header-section-number">1.6.3</span> (c)</h3>
<div id="22f55f98" class="cell" data-execution_count="65">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>beta1<span class="op">=</span><span class="dv">7</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="d-2" class="level3" data-number="1.6.4">
<h3 data-number="1.6.4" class="anchored" data-anchor-id="d-2"><span class="header-section-number">1.6.4</span> (d)</h3>
<div id="94877b7d" class="cell" data-execution_count="66">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>beta0<span class="op">=</span>simple_reg(Y<span class="op">-</span>beta1<span class="op">*</span>X1,X2)[<span class="dv">0</span>]</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>beta2<span class="op">=</span>simple_reg(Y<span class="op">-</span>beta1<span class="op">*</span>X1,X2)[<span class="dv">1</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="e-1" class="level3" data-number="1.6.5">
<h3 data-number="1.6.5" class="anchored" data-anchor-id="e-1"><span class="header-section-number">1.6.5</span> (e)</h3>
<div id="529f8c4c" class="cell" data-execution_count="67">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>beta0<span class="op">=</span>simple_reg(Y<span class="op">-</span>beta2<span class="op">*</span>X2,X1)[<span class="dv">0</span>]</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>beta1<span class="op">=</span>simple_reg(Y<span class="op">-</span>beta2<span class="op">*</span>X2,X1)[<span class="dv">1</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="f-1" class="level3" data-number="1.6.6">
<h3 data-number="1.6.6" class="anchored" data-anchor-id="f-1"><span class="header-section-number">1.6.6</span> (f)</h3>
<p>For more accuracy we should rename betas found in both questions d and e by betahat in order to distinguish theme from real betas chosen in the beginning of the exercise</p>
<div id="a7d2be91" class="cell" data-execution_count="68">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>betahat<span class="op">=</span>[beta0,beta1,beta2]</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>list_beta0<span class="op">=</span>[betahat[<span class="dv">0</span>]]</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>list_beta1<span class="op">=</span>[betahat[<span class="dv">1</span>]]</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>list_beta2<span class="op">=</span>[betahat[<span class="dv">2</span>]]</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1000</span>):</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>    list_beta2.append(simple_reg(Y<span class="op">-</span>list_beta1[i]<span class="op">*</span>X1,X2)[<span class="dv">1</span>])</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>    list_beta0.append(simple_reg(Y<span class="op">-</span>list_beta2[i]<span class="op">*</span>X2,X1)[<span class="dv">0</span>])</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>    list_beta1.append(simple_reg(Y<span class="op">-</span>list_beta2[i]<span class="op">*</span>X2,X1)[<span class="dv">1</span>])</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>betahat<span class="op">=</span>[list_beta0[<span class="op">-</span><span class="dv">1</span>],list_beta1[<span class="op">-</span><span class="dv">1</span>],list_beta2[<span class="op">-</span><span class="dv">1</span>]]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="2e221f59" class="cell" data-execution_count="69">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>betahat</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="149">
<pre><code>[np.float64(0.4047969576113646),
 np.float64(0.9688472571118021),
 np.float64(1.6861064800144077)]</code></pre>
</div>
</div>
<div id="8acb24ac" class="cell" data-execution_count="70">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="dv">1</span>,<span class="dv">1002</span>),list_beta0,label <span class="op">=</span> <span class="st">'Beta0'</span>)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="dv">1</span>,<span class="dv">1002</span>),list_beta1,label <span class="op">=</span> <span class="st">'Beta1'</span>)</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="dv">1</span>,<span class="dv">1002</span>),list_beta2,label <span class="op">=</span> <span class="st">'Beta2'</span>)</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Number of iterations'</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-71-output-1.png" width="542" height="359" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="g" class="level3" data-number="1.6.7">
<h3 data-number="1.6.7" class="anchored" data-anchor-id="g"><span class="header-section-number">1.6.7</span> (g)</h3>
<div id="dcd3972a" class="cell" data-execution_count="71">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>df<span class="op">=</span>pd.DataFrame({<span class="st">'y'</span>:Y,<span class="st">'X1'</span>:X1,<span class="st">'X2'</span>:X2})</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> MS([<span class="st">'X1'</span>, <span class="st">'X2'</span>]).fit_transform(df)</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> sm.OLS(Y, X)</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> model.fit()</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>summarize(results)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="151">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">coef</th>
<th data-quarto-table-cell-role="th">std err</th>
<th data-quarto-table-cell-role="th">t</th>
<th data-quarto-table-cell-role="th">P&gt;|t|</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">intercept</th>
<td>0.4048</td>
<td>0.107</td>
<td>3.777</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">X1</th>
<td>0.9688</td>
<td>0.100</td>
<td>9.718</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">X2</th>
<td>1.6861</td>
<td>0.102</td>
<td>16.596</td>
<td>0.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Both methods used in questions g and f yield the same results. As for Betahat, we notice that they are close to the real coefficients defined in question a.</p>
</section>
<section id="h" class="level3" data-number="1.6.8">
<h3 data-number="1.6.8" class="anchored" data-anchor-id="h"><span class="header-section-number">1.6.8</span> (h)</h3>
<p>We can limlit the x axis of the previous graph to visualize after the number of iterations after which the coefficients converge.</p>
<div id="d239079d" class="cell" data-execution_count="72">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="dv">1</span>,<span class="dv">1002</span>),list_beta0,label <span class="op">=</span> <span class="st">'Beta0'</span>)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="dv">1</span>,<span class="dv">1002</span>),list_beta1,label <span class="op">=</span> <span class="st">'Beta1'</span>)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="dv">1</span>,<span class="dv">1002</span>),list_beta2,label <span class="op">=</span> <span class="st">'Beta2'</span>)</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Number of iterations'</span>)</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="dv">0</span>,<span class="dv">10</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-73-output-1.png" width="550" height="359" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>After only 3 iterations, obtained results for the coefficients become stable.</p>
</section>
</section>
<section id="exercise-12" class="level2" data-number="1.7">
<h2 data-number="1.7" class="anchored" data-anchor-id="exercise-12"><span class="header-section-number">1.7</span> Exercise 12</h2>
<div id="bfc5bf57" class="cell" data-execution_count="73">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">45</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>X<span class="op">=</span>np.random.rand(<span class="dv">100</span>,<span class="dv">100</span>)</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> np.random.randn(<span class="dv">1</span>)</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>beta<span class="op">=</span>np.random.randn(<span class="dv">100</span>)</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>epsilon<span class="op">=</span>np.random.randn(<span class="dv">100</span>)</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>Y<span class="op">=</span>c<span class="op">+</span>np.matmul(X,beta)<span class="op">+</span>epsilon</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="bf9bb45b" class="cell" data-execution_count="74">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>lm<span class="op">=</span> LinearRegression()</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>(Y).shape</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="154">
<pre><code>(100,)</code></pre>
</div>
</div>
<div id="4634d570" class="cell" data-execution_count="75">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>Xn<span class="op">=</span>np.delete(X,<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>df<span class="op">=</span>pd.DataFrame(X, columns <span class="op">=</span> [<span class="st">'Column_'</span><span class="op">+</span><span class="bu">str</span>(i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>)])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="66089515" class="cell" data-execution_count="76">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>mul_beta_hat<span class="op">=</span>np.zeros(<span class="dv">100</span>)<span class="co">#beta estimators obtained by multiple linear regression</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>design <span class="op">=</span> MS(df).fit_transform(df)</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> sm.OLS(Y, design).fit()</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>):</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>    mul_beta_hat[j]<span class="op">=</span>result.params[<span class="dv">1</span>:].values[j]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="72ecc214" class="cell" data-execution_count="77">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a> mul_beta_hat.shape</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="157">
<pre><code>(100,)</code></pre>
</div>
</div>
<div id="29c8704e" class="cell" data-execution_count="78">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>n_iter<span class="op">=</span><span class="dv">100</span><span class="co">#number of iterations</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>mse<span class="op">=</span>np.zeros(n_iter)<span class="co">#mean squared error of the backfitted linear regression</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>diff_mse<span class="op">=</span>np.zeros(n_iter)<span class="co">#mean squared error among betas obtained by backfit and betas obtained by</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="co">#multiple linear regression</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>c_hat<span class="op">=</span>np.zeros((n_iter,<span class="dv">100</span>))<span class="co">#intercept estimators obtained by backfit</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>beta_hat<span class="op">=</span>np.zeros((n_iter,<span class="dv">100</span>))<span class="co">#beta estimators obtained by backfit</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(n_iter):</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>):</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>        beta_hat_i<span class="op">=</span>np.delete(beta_hat[j,:],i,<span class="dv">0</span>)</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>        term<span class="op">=</span>np.matmul(np.concatenate((X[:,:i], X[:,i<span class="op">+</span><span class="dv">1</span>:]), axis<span class="op">=</span><span class="dv">1</span>),beta_hat_i)</span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>        c_hat[j:n_iter,i]<span class="op">=</span>lm.fit(X[:,i].reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>),Y<span class="op">-</span>term).intercept_</span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>        beta_hat[j:n_iter,i]<span class="op">=</span>lm.fit(X[:,i].reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>),Y<span class="op">-</span>term).coef_[<span class="dv">0</span>]</span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>    mse[j]<span class="op">=</span>mean_squared_error(Y, c_hat[j,i]<span class="op">+</span>np.matmul(X,beta_hat[j,:]))</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>    diff_mse[j]<span class="op">=</span>mean_squared_error(mul_beta_hat,beta_hat[j,:])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="dde8cf46" class="cell" data-execution_count="79">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>ax<span class="op">=</span>subplots(figsize<span class="op">=</span>(<span class="dv">20</span>,<span class="dv">20</span>))[<span class="dv">1</span>]</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>ax.scatter(<span class="bu">range</span>(<span class="dv">1</span>,n_iter<span class="op">+</span><span class="dv">1</span>), mse)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Nth iteration'</span>)</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Backfitting MSE for Y'</span>) </span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">' MSE '</span>) <span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-80-output-1.png" width="1565" height="1558" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="63837120" class="cell" data-execution_count="80">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>ax<span class="op">=</span>subplots(figsize<span class="op">=</span>(<span class="dv">20</span>,<span class="dv">20</span>))[<span class="dv">1</span>]</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>ax.scatter(<span class="bu">range</span>(<span class="dv">1</span>,n_iter<span class="op">+</span><span class="dv">1</span>), diff_mse)</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Nth iteration'</span>)</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'MLR beats vs Backfitting betas'</span>) </span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">' MSE '</span>) <span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Chapter%207_files/figure-html/cell-81-output-1.png" width="1565" height="1558" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>After 20 iterations mean square errors differences are with the last iteration are considered negligeable.</p>
<!-- -->

</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb101" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Moving Beyond Linearity"</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Chapter 7: ISLR2 Exercise Solutions"</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Shad Ali Shah"</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> today</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 2</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-location: left</span></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a><span class="co">    number-depth: 3</span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a><span class="co">    code-summary: "Show code"</span></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a><span class="co">    theme: cosmo</span></span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a><span class="co">    colorlinks: true</span></span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a><span class="co">    link-citations: true</span></span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a><span class="co">    df-print: kable</span></span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a><span class="co">    fig-cap-location: bottom</span></span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a><span class="co">    tbl-cap-location: top</span></span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a><span class="co">    crossref:</span></span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a><span class="co">      fig-title: "Figure"</span></span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a><span class="co">      tbl-title: "Table"</span></span>
<span id="cb101-25"><a href="#cb101-25" aria-hidden="true" tabindex="-1"></a><span class="co">      fig-prefix: "Fig."</span></span>
<span id="cb101-26"><a href="#cb101-26" aria-hidden="true" tabindex="-1"></a><span class="co">      tbl-prefix: "Table"</span></span>
<span id="cb101-27"><a href="#cb101-27" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb101-28"><a href="#cb101-28" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb101-29"><a href="#cb101-29" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb101-30"><a href="#cb101-30" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb101-31"><a href="#cb101-31" aria-hidden="true" tabindex="-1"></a><span class="co">  error: true</span></span>
<span id="cb101-32"><a href="#cb101-32" aria-hidden="true" tabindex="-1"></a><span class="co">  cache: false</span></span>
<span id="cb101-33"><a href="#cb101-33" aria-hidden="true" tabindex="-1"></a><span class="co">  keep-going: true</span></span>
<span id="cb101-34"><a href="#cb101-34" aria-hidden="true" tabindex="-1"></a><span class="co">  fig-width: 6.5</span></span>
<span id="cb101-35"><a href="#cb101-35" aria-hidden="true" tabindex="-1"></a><span class="co">  fig-height: 4</span></span>
<span id="cb101-36"><a href="#cb101-36" aria-hidden="true" tabindex="-1"></a><span class="an">jupyter:</span><span class="co"> python3</span></span>
<span id="cb101-37"><a href="#cb101-37" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb101-38"><a href="#cb101-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-39"><a href="#cb101-39" aria-hidden="true" tabindex="-1"></a><span class="fu"># Chapter 7</span></span>
<span id="cb101-40"><a href="#cb101-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-41"><a href="#cb101-41" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercise 6</span></span>
<span id="cb101-42"><a href="#cb101-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-45"><a href="#cb101-45" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-46"><a href="#cb101-46" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np, pandas <span class="im">as</span> pd</span>
<span id="cb101-47"><a href="#cb101-47" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.pyplot <span class="im">import</span> subplots</span>
<span id="cb101-48"><a href="#cb101-48" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb101-49"><a href="#cb101-49" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb101-50"><a href="#cb101-50" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.api <span class="im">import</span> OLS</span>
<span id="cb101-51"><a href="#cb101-51" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP <span class="im">import</span> load_data</span>
<span id="cb101-52"><a href="#cb101-52" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP.models <span class="im">import</span> (summarize,</span>
<span id="cb101-53"><a href="#cb101-53" aria-hidden="true" tabindex="-1"></a>                         Stepwise,</span>
<span id="cb101-54"><a href="#cb101-54" aria-hidden="true" tabindex="-1"></a>                         sklearn_selected,</span>
<span id="cb101-55"><a href="#cb101-55" aria-hidden="true" tabindex="-1"></a>                         poly,</span>
<span id="cb101-56"><a href="#cb101-56" aria-hidden="true" tabindex="-1"></a>                         ModelSpec <span class="im">as</span> MS)</span>
<span id="cb101-57"><a href="#cb101-57" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.stats.anova <span class="im">import</span> anova_lm</span>
<span id="cb101-58"><a href="#cb101-58" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP.models <span class="im">import</span> sklearn_sm</span>
<span id="cb101-59"><a href="#cb101-59" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_validate, KFold</span>
<span id="cb101-60"><a href="#cb101-60" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb101-61"><a href="#cb101-61" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb101-62"><a href="#cb101-62" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-63"><a href="#cb101-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-66"><a href="#cb101-66" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-67"><a href="#cb101-67" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pygam <span class="im">import</span> (s <span class="im">as</span> s_gam, l <span class="im">as</span> l_gam, f <span class="im">as</span> f_gam, LinearGAM, LogisticGAM)</span>
<span id="cb101-68"><a href="#cb101-68" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP.transforms <span class="im">import</span> (BSpline, NaturalSpline)</span>
<span id="cb101-69"><a href="#cb101-69" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP.models <span class="im">import</span> bs, ns</span>
<span id="cb101-70"><a href="#cb101-70" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP.pygam <span class="im">import</span> (approx_lam, degrees_of_freedom, plot <span class="im">as</span> plot_gam, anova <span class="im">as</span> anova_gam)</span>
<span id="cb101-71"><a href="#cb101-71" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb101-72"><a href="#cb101-72" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> r2_score,mean_squared_error</span>
<span id="cb101-73"><a href="#cb101-73" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-74"><a href="#cb101-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-77"><a href="#cb101-77" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-78"><a href="#cb101-78" aria-hidden="true" tabindex="-1"></a>Wage<span class="op">=</span>load_data(<span class="st">'Wage'</span>)</span>
<span id="cb101-79"><a href="#cb101-79" aria-hidden="true" tabindex="-1"></a>y<span class="op">=</span>Wage[<span class="st">'wage'</span>]</span>
<span id="cb101-80"><a href="#cb101-80" aria-hidden="true" tabindex="-1"></a>age<span class="op">=</span>Wage[<span class="st">'age'</span>]</span>
<span id="cb101-81"><a href="#cb101-81" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-82"><a href="#cb101-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-83"><a href="#cb101-83" aria-hidden="true" tabindex="-1"></a><span class="fu">### (a)</span></span>
<span id="cb101-84"><a href="#cb101-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-85"><a href="#cb101-85" aria-hidden="true" tabindex="-1"></a>Generally speaking it is unusual to use a polynomial degree greater than 4 because for larger degrees polynomials become overly flexible, which raises the risk of overfitting the data.</span>
<span id="cb101-86"><a href="#cb101-86" aria-hidden="true" tabindex="-1"></a>For this reason we choose test the cross validation model for a maximum degree of 6.</span>
<span id="cb101-87"><a href="#cb101-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-88"><a href="#cb101-88" aria-hidden="true" tabindex="-1"></a>The cross validation error is minimal when the polynomial degree equals 4.</span>
<span id="cb101-89"><a href="#cb101-89" aria-hidden="true" tabindex="-1"></a>Now let's use ANOVA to check the obtained result.</span>
<span id="cb101-90"><a href="#cb101-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-93"><a href="#cb101-93" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-94"><a href="#cb101-94" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> [MS([poly(<span class="st">'age'</span>, degree<span class="op">=</span>d)]) <span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">7</span>)]</span>
<span id="cb101-95"><a href="#cb101-95" aria-hidden="true" tabindex="-1"></a>Xs <span class="op">=</span> [model.fit_transform(Wage) <span class="cf">for</span> model <span class="kw">in</span> models]</span>
<span id="cb101-96"><a href="#cb101-96" aria-hidden="true" tabindex="-1"></a>anova_lm(<span class="op">*</span>[sm.OLS(y, X_).fit() <span class="cf">for</span> X_ <span class="kw">in</span> Xs])</span>
<span id="cb101-97"><a href="#cb101-97" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-98"><a href="#cb101-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-99"><a href="#cb101-99" aria-hidden="true" tabindex="-1"></a>The results above show that model<span class="co">[</span><span class="ot">4</span><span class="co">]</span> and model<span class="co">[</span><span class="ot">5</span><span class="co">]</span> cannot be optimal since relative p-values are already larger than 5%.</span>
<span id="cb101-100"><a href="#cb101-100" aria-hidden="true" tabindex="-1"></a>On the other side we notice the best improvement for model<span class="co">[</span><span class="ot">3</span><span class="co">]</span> which corresponds to polynomial of degree 4.</span>
<span id="cb101-101"><a href="#cb101-101" aria-hidden="true" tabindex="-1"></a>Clearly both cross-vaidation approach and ANOVA yield the same results.</span>
<span id="cb101-102"><a href="#cb101-102" aria-hidden="true" tabindex="-1"></a>Now let's plot the fitted polynomial against the data scatter. We opt to define a function which does the work as the lab did. For this function must be useful whenever we opt for another polynomial degree.</span>
<span id="cb101-103"><a href="#cb101-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-106"><a href="#cb101-106" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-107"><a href="#cb101-107" aria-hidden="true" tabindex="-1"></a><span class="co"># define a grid of 100 points over which we can compute model predictions </span></span>
<span id="cb101-108"><a href="#cb101-108" aria-hidden="true" tabindex="-1"></a>age_grid <span class="op">=</span> np.linspace(age.<span class="bu">min</span>(), age.<span class="bu">max</span>(), <span class="dv">100</span>)</span>
<span id="cb101-109"><a href="#cb101-109" aria-hidden="true" tabindex="-1"></a>age_df<span class="op">=</span>pd.DataFrame({<span class="st">'age'</span>:age_grid})</span>
<span id="cb101-110"><a href="#cb101-110" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-111"><a href="#cb101-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-114"><a href="#cb101-114" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-115"><a href="#cb101-115" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_wage_fit(age_df, basis, title):</span>
<span id="cb101-116"><a href="#cb101-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-117"><a href="#cb101-117" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> basis.transform(Wage)</span>
<span id="cb101-118"><a href="#cb101-118" aria-hidden="true" tabindex="-1"></a>    Xnew <span class="op">=</span> basis.transform(age_df)</span>
<span id="cb101-119"><a href="#cb101-119" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb101-120"><a href="#cb101-120" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> M.get_prediction(Xnew)</span>
<span id="cb101-121"><a href="#cb101-121" aria-hidden="true" tabindex="-1"></a>    bands <span class="op">=</span> preds.conf_int(alpha<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb101-122"><a href="#cb101-122" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb101-123"><a href="#cb101-123" aria-hidden="true" tabindex="-1"></a>    ax.scatter(age,y,facecolor<span class="op">=</span><span class="st">'gray'</span>,alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb101-124"><a href="#cb101-124" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> val, ls <span class="kw">in</span> <span class="bu">zip</span>([preds.predicted_mean,bands[:,<span class="dv">0</span>],bands[:,<span class="dv">1</span>]],[<span class="st">'b'</span>,<span class="st">'r--'</span>,<span class="st">'r--'</span>]):</span>
<span id="cb101-125"><a href="#cb101-125" aria-hidden="true" tabindex="-1"></a>        ax.plot(age_df.values, val, ls, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb101-126"><a href="#cb101-126" aria-hidden="true" tabindex="-1"></a>    ax.set_title(title, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb101-127"><a href="#cb101-127" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'Age'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb101-128"><a href="#cb101-128" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Wage'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb101-129"><a href="#cb101-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span>
<span id="cb101-130"><a href="#cb101-130" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-131"><a href="#cb101-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-132"><a href="#cb101-132" aria-hidden="true" tabindex="-1"></a>age_df is fixed and already defined, basis will be the fitted model corresponding to polynomial of degree 4 and title can be chosen as expressive as it must be.</span>
<span id="cb101-133"><a href="#cb101-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-136"><a href="#cb101-136" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-137"><a href="#cb101-137" aria-hidden="true" tabindex="-1"></a>model4<span class="op">=</span>MS([poly(<span class="st">'age'</span>, degree<span class="op">=</span><span class="dv">4</span>)]).fit(Wage)</span>
<span id="cb101-138"><a href="#cb101-138" aria-hidden="true" tabindex="-1"></a>plot_wage_fit(age_df, model4, <span class="st">'4 degree polynomial'</span>)</span>
<span id="cb101-139"><a href="#cb101-139" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-140"><a href="#cb101-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-143"><a href="#cb101-143" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-144"><a href="#cb101-144" aria-hidden="true" tabindex="-1"></a><span class="co">#Perform corss validation to find the best polynomial degree</span></span>
<span id="cb101-145"><a href="#cb101-145" aria-hidden="true" tabindex="-1"></a>cv_error <span class="op">=</span> np.zeros(<span class="dv">6</span>)</span>
<span id="cb101-146"><a href="#cb101-146" aria-hidden="true" tabindex="-1"></a>H <span class="op">=</span> np.array(age)</span>
<span id="cb101-147"><a href="#cb101-147" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> sklearn_sm(sm.OLS)</span>
<span id="cb101-148"><a href="#cb101-148" aria-hidden="true" tabindex="-1"></a><span class="co">#Let's introduce splits. We choose 5-folds cross validation for this example</span></span>
<span id="cb101-149"><a href="#cb101-149" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> KFold(n_splits<span class="op">=</span><span class="dv">5</span>,shuffle<span class="op">=</span><span class="va">True</span>,random_state<span class="op">=</span><span class="dv">0</span>) <span class="co"># The argument shuffle allows samples to overlap</span></span>
<span id="cb101-150"><a href="#cb101-150" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, d <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">7</span>)):</span>
<span id="cb101-151"><a href="#cb101-151" aria-hidden="true" tabindex="-1"></a>    Xcross <span class="op">=</span> np.power.outer(H, np.arange(d<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb101-152"><a href="#cb101-152" aria-hidden="true" tabindex="-1"></a>    M_CV <span class="op">=</span> cross_validate(M,Xcross,y,cv<span class="op">=</span>cv)</span>
<span id="cb101-153"><a href="#cb101-153" aria-hidden="true" tabindex="-1"></a>    cv_error[i] <span class="op">=</span> np.mean(M_CV[<span class="st">'test_score'</span>])</span>
<span id="cb101-154"><a href="#cb101-154" aria-hidden="true" tabindex="-1"></a>cv_error</span>
<span id="cb101-155"><a href="#cb101-155" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-156"><a href="#cb101-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-157"><a href="#cb101-157" aria-hidden="true" tabindex="-1"></a><span class="fu">### (b)</span></span>
<span id="cb101-158"><a href="#cb101-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-159"><a href="#cb101-159" aria-hidden="true" tabindex="-1"></a>We'll try to compare 20 models of step functions using cross validation. </span>
<span id="cb101-160"><a href="#cb101-160" aria-hidden="true" tabindex="-1"></a>Each of these models correponds to a different number of cutpoints.</span>
<span id="cb101-161"><a href="#cb101-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-162"><a href="#cb101-162" aria-hidden="true" tabindex="-1"></a>For this we'll let the function qcut() from the pandas library automatically choose cutpoints based on quantiles. </span>
<span id="cb101-163"><a href="#cb101-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-166"><a href="#cb101-166" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-167"><a href="#cb101-167" aria-hidden="true" tabindex="-1"></a>cv_error_cuts <span class="op">=</span> np.zeros(<span class="dv">20</span>)</span>
<span id="cb101-168"><a href="#cb101-168" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, d <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">21</span>)):</span>
<span id="cb101-169"><a href="#cb101-169" aria-hidden="true" tabindex="-1"></a>    Xcross <span class="op">=</span> pd.qcut(age, d<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb101-170"><a href="#cb101-170" aria-hidden="true" tabindex="-1"></a>    M_CV_cut <span class="op">=</span> cross_validate(M,pd.get_dummies(Xcross),y,cv<span class="op">=</span>cv)</span>
<span id="cb101-171"><a href="#cb101-171" aria-hidden="true" tabindex="-1"></a>    cv_error_cuts[i] <span class="op">=</span> np.mean(M_CV_cut[<span class="st">'test_score'</span>])</span>
<span id="cb101-172"><a href="#cb101-172" aria-hidden="true" tabindex="-1"></a>cv_error_cuts</span>
<span id="cb101-173"><a href="#cb101-173" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-174"><a href="#cb101-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-175"><a href="#cb101-175" aria-hidden="true" tabindex="-1"></a>The minimal CV error occurs when there are 12 cutpoints. We also could have chosen 8 cutpoints if there were less investigations.</span>
<span id="cb101-176"><a href="#cb101-176" aria-hidden="true" tabindex="-1"></a>First, we must fit the model as the function previously defined does not take into account the modified data frame coming from splitting the age feature.</span>
<span id="cb101-177"><a href="#cb101-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-180"><a href="#cb101-180" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-181"><a href="#cb101-181" aria-hidden="true" tabindex="-1"></a>n_groups<span class="op">=</span><span class="dv">12</span></span>
<span id="cb101-182"><a href="#cb101-182" aria-hidden="true" tabindex="-1"></a>cut_age <span class="op">=</span> pd.qcut(age, n_groups<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb101-183"><a href="#cb101-183" aria-hidden="true" tabindex="-1"></a><span class="co"># Get dummy features relatively to age groups</span></span>
<span id="cb101-184"><a href="#cb101-184" aria-hidden="true" tabindex="-1"></a>dummy_age<span class="op">=</span>pd.get_dummies(cut_age)</span>
<span id="cb101-185"><a href="#cb101-185" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-186"><a href="#cb101-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-189"><a href="#cb101-189" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-190"><a href="#cb101-190" aria-hidden="true" tabindex="-1"></a><span class="co">#Create a new data frame to fit the new model</span></span>
<span id="cb101-191"><a href="#cb101-191" aria-hidden="true" tabindex="-1"></a>df_step<span class="op">=</span>pd.concat([dummy_age, y], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb101-192"><a href="#cb101-192" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign roles to each of the columns of the new data set and ft the model</span></span>
<span id="cb101-193"><a href="#cb101-193" aria-hidden="true" tabindex="-1"></a>Xnew<span class="op">=</span>df_step.iloc[:,:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb101-194"><a href="#cb101-194" aria-hidden="true" tabindex="-1"></a>ynew<span class="op">=</span>df_step.iloc[:,<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb101-195"><a href="#cb101-195" aria-hidden="true" tabindex="-1"></a>ynewnp<span class="op">=</span>np.array(ynew)[:,np.newaxis]</span>
<span id="cb101-196"><a href="#cb101-196" aria-hidden="true" tabindex="-1"></a>model_step<span class="op">=</span>MS(Xnew,intercept<span class="op">=</span><span class="va">False</span>).fit(df_step)</span>
<span id="cb101-197"><a href="#cb101-197" aria-hidden="true" tabindex="-1"></a>X<span class="op">=</span>model_step.transform(df_step)</span>
<span id="cb101-198"><a href="#cb101-198" aria-hidden="true" tabindex="-1"></a>res<span class="op">=</span>sm.OLS(ynewnp,X).fit()</span>
<span id="cb101-199"><a href="#cb101-199" aria-hidden="true" tabindex="-1"></a>X.shape</span>
<span id="cb101-200"><a href="#cb101-200" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-201"><a href="#cb101-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-204"><a href="#cb101-204" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-205"><a href="#cb101-205" aria-hidden="true" tabindex="-1"></a><span class="co">#Define a gird over which we can plot predictions. Since the ages start from 18 and end at 80</span></span>
<span id="cb101-206"><a href="#cb101-206" aria-hidden="true" tabindex="-1"></a><span class="co"># we choose to define a grid of integer numbers through this interval</span></span>
<span id="cb101-207"><a href="#cb101-207" aria-hidden="true" tabindex="-1"></a>X_grid<span class="op">=</span>np.linspace(<span class="dv">18</span>,<span class="dv">80</span>)</span>
<span id="cb101-208"><a href="#cb101-208" aria-hidden="true" tabindex="-1"></a><span class="co">#Now let's cut the defined grid over the predifined groups. We use the cut function to create an</span></span>
<span id="cb101-209"><a href="#cb101-209" aria-hidden="true" tabindex="-1"></a><span class="co"># ordered set of values</span></span>
<span id="cb101-210"><a href="#cb101-210" aria-hidden="true" tabindex="-1"></a>groups <span class="op">=</span> pd.cut(X_grid, n_groups<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb101-211"><a href="#cb101-211" aria-hidden="true" tabindex="-1"></a>dummies <span class="op">=</span> pd.get_dummies(groups)</span>
<span id="cb101-212"><a href="#cb101-212" aria-hidden="true" tabindex="-1"></a>dummies.shape</span>
<span id="cb101-213"><a href="#cb101-213" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-214"><a href="#cb101-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-217"><a href="#cb101-217" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-218"><a href="#cb101-218" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the function </span></span>
<span id="cb101-219"><a href="#cb101-219" aria-hidden="true" tabindex="-1"></a>X_step <span class="op">=</span> np.linspace(<span class="dv">18</span>,<span class="dv">80</span>)</span>
<span id="cb101-220"><a href="#cb101-220" aria-hidden="true" tabindex="-1"></a>y_step <span class="op">=</span> res.predict(dummies)</span>
<span id="cb101-221"><a href="#cb101-221" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb101-222"><a href="#cb101-222" aria-hidden="true" tabindex="-1"></a>plt.scatter(age,y)</span>
<span id="cb101-223"><a href="#cb101-223" aria-hidden="true" tabindex="-1"></a>plt.plot(X_step, y_step,<span class="st">'-r'</span>)</span>
<span id="cb101-224"><a href="#cb101-224" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Step function'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb101-225"><a href="#cb101-225" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Age'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb101-226"><a href="#cb101-226" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Wage'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb101-227"><a href="#cb101-227" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-228"><a href="#cb101-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-229"><a href="#cb101-229" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercise 7</span></span>
<span id="cb101-230"><a href="#cb101-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-233"><a href="#cb101-233" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-234"><a href="#cb101-234" aria-hidden="true" tabindex="-1"></a>Wage.info()</span>
<span id="cb101-235"><a href="#cb101-235" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-236"><a href="#cb101-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-239"><a href="#cb101-239" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-240"><a href="#cb101-240" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert both 'maritl' and 'joblcass' columns to categorical data</span></span>
<span id="cb101-241"><a href="#cb101-241" aria-hidden="true" tabindex="-1"></a>Wage[<span class="st">'maritl'</span>]<span class="op">=</span>Wage[<span class="st">'maritl'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb101-242"><a href="#cb101-242" aria-hidden="true" tabindex="-1"></a>Wage[<span class="st">'jobclass'</span>]<span class="op">=</span>Wage[<span class="st">'jobclass'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb101-243"><a href="#cb101-243" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-244"><a href="#cb101-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-247"><a href="#cb101-247" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-248"><a href="#cb101-248" aria-hidden="true" tabindex="-1"></a>Wage.info()</span>
<span id="cb101-249"><a href="#cb101-249" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-250"><a href="#cb101-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-251"><a href="#cb101-251" aria-hidden="true" tabindex="-1"></a>As the Wage data set contains 3000 observations, it is preferable to use distribution plots. We'll choose to draw boxplots then to discover the relationships among 'wage' feature and both 'maritl' and 'jobclass'.</span>
<span id="cb101-252"><a href="#cb101-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-255"><a href="#cb101-255" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-256"><a href="#cb101-256" aria-hidden="true" tabindex="-1"></a>Wage.boxplot(column<span class="op">=</span>[<span class="st">'wage'</span>],by<span class="op">=</span>[<span class="st">'maritl'</span>])<span class="op">;</span></span>
<span id="cb101-257"><a href="#cb101-257" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-258"><a href="#cb101-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-259"><a href="#cb101-259" aria-hidden="true" tabindex="-1"></a>It seems from observing the medians that wage is highet for married people.</span>
<span id="cb101-260"><a href="#cb101-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-263"><a href="#cb101-263" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-264"><a href="#cb101-264" aria-hidden="true" tabindex="-1"></a>Wage.boxplot(column<span class="op">=</span>[<span class="st">'wage'</span>],by<span class="op">=</span>[<span class="st">'jobclass'</span>])<span class="op">;</span></span>
<span id="cb101-265"><a href="#cb101-265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-266"><a href="#cb101-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-267"><a href="#cb101-267" aria-hidden="true" tabindex="-1"></a>Information jobs are better paid than industrial ones.</span>
<span id="cb101-268"><a href="#cb101-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-269"><a href="#cb101-269" aria-hidden="true" tabindex="-1"></a>Now we should explore models with and without those categorical features along with age feature through GAM. We can compare models using ANOVA_GAM.</span>
<span id="cb101-270"><a href="#cb101-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-273"><a href="#cb101-273" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-274"><a href="#cb101-274" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare three models: first model is the full model cause it contains all the three features</span></span>
<span id="cb101-275"><a href="#cb101-275" aria-hidden="true" tabindex="-1"></a><span class="co"># second model contains age and maritl features</span></span>
<span id="cb101-276"><a href="#cb101-276" aria-hidden="true" tabindex="-1"></a><span class="co"># third model contains age and jobclass features</span></span>
<span id="cb101-277"><a href="#cb101-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-278"><a href="#cb101-278" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's fit the first model</span></span>
<span id="cb101-279"><a href="#cb101-279" aria-hidden="true" tabindex="-1"></a>gam_full <span class="op">=</span> LinearGAM(s_gam(<span class="dv">0</span>) <span class="op">+</span> f_gam(<span class="dv">1</span>, lam<span class="op">=</span><span class="dv">0</span>) <span class="op">+</span>f_gam(<span class="dv">2</span>, lam<span class="op">=</span><span class="dv">0</span>))<span class="co"># lam=0 to avoid shrinkage for categ terms</span></span>
<span id="cb101-280"><a href="#cb101-280" aria-hidden="true" tabindex="-1"></a>Xgam <span class="op">=</span> np.column_stack([age, Wage[<span class="st">'maritl'</span>].cat.codes, Wage[<span class="st">'jobclass'</span>].cat.codes])</span>
<span id="cb101-281"><a href="#cb101-281" aria-hidden="true" tabindex="-1"></a>gam_full <span class="op">=</span> gam_full.fit(Xgam, y)</span>
<span id="cb101-282"><a href="#cb101-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-283"><a href="#cb101-283" aria-hidden="true" tabindex="-1"></a><span class="co">#Fit the second model</span></span>
<span id="cb101-284"><a href="#cb101-284" aria-hidden="true" tabindex="-1"></a>gam_m<span class="op">=</span>LinearGAM(s_gam(<span class="dv">0</span>) <span class="op">+</span> f_gam(<span class="dv">1</span>, lam<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb101-285"><a href="#cb101-285" aria-hidden="true" tabindex="-1"></a>gam_m <span class="op">=</span> gam_m.fit(Xgam, y)</span>
<span id="cb101-286"><a href="#cb101-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-287"><a href="#cb101-287" aria-hidden="true" tabindex="-1"></a><span class="co">#Fit the third model</span></span>
<span id="cb101-288"><a href="#cb101-288" aria-hidden="true" tabindex="-1"></a>gam_j<span class="op">=</span>LinearGAM(s_gam(<span class="dv">0</span>) <span class="op">+</span> f_gam(<span class="dv">2</span>, lam<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb101-289"><a href="#cb101-289" aria-hidden="true" tabindex="-1"></a>gam_j <span class="op">=</span> gam_j.fit(Xgam, y)</span>
<span id="cb101-290"><a href="#cb101-290" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-291"><a href="#cb101-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-294"><a href="#cb101-294" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-295"><a href="#cb101-295" aria-hidden="true" tabindex="-1"></a><span class="co">#compare the models</span></span>
<span id="cb101-296"><a href="#cb101-296" aria-hidden="true" tabindex="-1"></a><span class="co">#Switch the order of arguments in anova_gam to see the difference. Basically this enables the function</span></span>
<span id="cb101-297"><a href="#cb101-297" aria-hidden="true" tabindex="-1"></a><span class="co"># to choose positive degrees of freedom for F test.</span></span>
<span id="cb101-298"><a href="#cb101-298" aria-hidden="true" tabindex="-1"></a>anova_gam(gam_j,gam_m,gam_full)</span>
<span id="cb101-299"><a href="#cb101-299" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-300"><a href="#cb101-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-301"><a href="#cb101-301" aria-hidden="true" tabindex="-1"></a>We find a compelling result showing that the full model, gven its pvalue, is better that the other ones. </span>
<span id="cb101-302"><a href="#cb101-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-303"><a href="#cb101-303" aria-hidden="true" tabindex="-1"></a>In order to present the results, we draw the partial dependence plots for each of the features.</span>
<span id="cb101-304"><a href="#cb101-304" aria-hidden="true" tabindex="-1"></a>For that, we assume that the three studied features are independant.</span>
<span id="cb101-305"><a href="#cb101-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-308"><a href="#cb101-308" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-309"><a href="#cb101-309" aria-hidden="true" tabindex="-1"></a><span class="co"># Effect of age in the full model on the wage</span></span>
<span id="cb101-310"><a href="#cb101-310" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb101-311"><a href="#cb101-311" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plot_gam(gam_full, <span class="dv">0</span>)</span>
<span id="cb101-312"><a href="#cb101-312" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Age'</span>)</span>
<span id="cb101-313"><a href="#cb101-313" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Effect on wage'</span>)</span>
<span id="cb101-314"><a href="#cb101-314" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Partial dependence of wage on age'</span>,fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb101-315"><a href="#cb101-315" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-316"><a href="#cb101-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-317"><a href="#cb101-317" aria-hidden="true" tabindex="-1"></a>The function is somewhat wiggly. This issue has been overcome in the lab by refitting the model along with specifiying degrees of freedom.</span>
<span id="cb101-318"><a href="#cb101-318" aria-hidden="true" tabindex="-1"></a>In either cases, the tendancy of age effect on wage will be the same. It shows that the best wage is obtained at the age between 40 and approximately 45.</span>
<span id="cb101-319"><a href="#cb101-319" aria-hidden="true" tabindex="-1"></a>A similar wage range can be seen at the age around 60.</span>
<span id="cb101-320"><a href="#cb101-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-323"><a href="#cb101-323" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-324"><a href="#cb101-324" aria-hidden="true" tabindex="-1"></a><span class="co">#The following two lines are added because plot_gam function used thereafter does not proceed</span></span>
<span id="cb101-325"><a href="#cb101-325" aria-hidden="true" tabindex="-1"></a><span class="co"># when the categorical data to be ploted is in the middle of the matrix model</span></span>
<span id="cb101-326"><a href="#cb101-326" aria-hidden="true" tabindex="-1"></a>Xgam2 <span class="op">=</span> np.column_stack([age, Wage[<span class="st">'jobclass'</span>].cat.codes, Wage[<span class="st">'maritl'</span>].cat.codes])</span>
<span id="cb101-327"><a href="#cb101-327" aria-hidden="true" tabindex="-1"></a>gam_full <span class="op">=</span> gam_full.fit(Xgam2, y)</span>
<span id="cb101-328"><a href="#cb101-328" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-329"><a href="#cb101-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-332"><a href="#cb101-332" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-333"><a href="#cb101-333" aria-hidden="true" tabindex="-1"></a><span class="co">#Effect of maritl in the full model on the wage</span></span>
<span id="cb101-334"><a href="#cb101-334" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">12</span>))</span>
<span id="cb101-335"><a href="#cb101-335" aria-hidden="true" tabindex="-1"></a>ax<span class="op">=</span>plot_gam(gam_full,<span class="dv">2</span>)</span>
<span id="cb101-336"><a href="#cb101-336" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Marital status'</span>)</span>
<span id="cb101-337"><a href="#cb101-337" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Effect on wage'</span>)</span>
<span id="cb101-338"><a href="#cb101-338" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Partial dependence of wage on marital status'</span>,fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb101-339"><a href="#cb101-339" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(Wage[<span class="st">'maritl'</span>].cat.categories, fontsize<span class="op">=</span><span class="dv">8</span>)<span class="op">;</span></span>
<span id="cb101-340"><a href="#cb101-340" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-341"><a href="#cb101-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-342"><a href="#cb101-342" aria-hidden="true" tabindex="-1"></a>We notice that the max effect on wage is obtained when the marital status is married followed by never married category. Other categories of marital satuts seem to have a positive effect on wage too, but this effect remains low.</span>
<span id="cb101-343"><a href="#cb101-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-346"><a href="#cb101-346" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-347"><a href="#cb101-347" aria-hidden="true" tabindex="-1"></a><span class="co">#Effect of jobclass in the full model on the wage</span></span>
<span id="cb101-348"><a href="#cb101-348" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb101-349"><a href="#cb101-349" aria-hidden="true" tabindex="-1"></a>ax<span class="op">=</span>plot_gam(gam_full,<span class="dv">1</span>)</span>
<span id="cb101-350"><a href="#cb101-350" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Job class'</span>)</span>
<span id="cb101-351"><a href="#cb101-351" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Effect on wage'</span>)</span>
<span id="cb101-352"><a href="#cb101-352" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Partial dependence of wage on job class'</span>,fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb101-353"><a href="#cb101-353" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(Wage[<span class="st">'jobclass'</span>].cat.categories, fontsize<span class="op">=</span><span class="dv">8</span>)<span class="op">;</span></span>
<span id="cb101-354"><a href="#cb101-354" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-355"><a href="#cb101-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-356"><a href="#cb101-356" aria-hidden="true" tabindex="-1"></a>As predicted the effect of infomation jobs on wage is more important than the effect of industrial jobs.</span>
<span id="cb101-357"><a href="#cb101-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-358"><a href="#cb101-358" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercise 8</span></span>
<span id="cb101-359"><a href="#cb101-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-362"><a href="#cb101-362" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-363"><a href="#cb101-363" aria-hidden="true" tabindex="-1"></a>Auto<span class="op">=</span>load_data(<span class="st">'Auto'</span>)</span>
<span id="cb101-364"><a href="#cb101-364" aria-hidden="true" tabindex="-1"></a>horsepower<span class="op">=</span>Auto[<span class="st">'horsepower'</span>]</span>
<span id="cb101-365"><a href="#cb101-365" aria-hidden="true" tabindex="-1"></a>mpg<span class="op">=</span>Auto[<span class="st">'mpg'</span>]</span>
<span id="cb101-366"><a href="#cb101-366" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-367"><a href="#cb101-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-370"><a href="#cb101-370" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-371"><a href="#cb101-371" aria-hidden="true" tabindex="-1"></a>pd.plotting.scatter_matrix(Auto, figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">12</span>), marker <span class="op">=</span> <span class="st">'o'</span>, </span>
<span id="cb101-372"><a href="#cb101-372" aria-hidden="true" tabindex="-1"></a>                           hist_kwds <span class="op">=</span> {<span class="st">'bins'</span>: <span class="dv">10</span>}, s <span class="op">=</span> <span class="dv">15</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>)<span class="op">;</span></span>
<span id="cb101-373"><a href="#cb101-373" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-374"><a href="#cb101-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-375"><a href="#cb101-375" aria-hidden="true" tabindex="-1"></a>In the book we analyse the behavior of mpg depending on other features. Let's just analyze the same feature as an output.</span>
<span id="cb101-376"><a href="#cb101-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-379"><a href="#cb101-379" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-380"><a href="#cb101-380" aria-hidden="true" tabindex="-1"></a>Auto.corr()</span>
<span id="cb101-381"><a href="#cb101-381" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-382"><a href="#cb101-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-383"><a href="#cb101-383" aria-hidden="true" tabindex="-1"></a>By looking at the correlation matrix and the previous pairplot, it is predictible that mpg has non linear relationships with cylinders, displacement, horsepower and weight.</span>
<span id="cb101-384"><a href="#cb101-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-385"><a href="#cb101-385" aria-hidden="true" tabindex="-1"></a>Features seem to be highly correlated. Modelization with one predictible variable sounds a wise choice. For this we will try to regress mpg on horsepower as the previous chapters of the book did.</span>
<span id="cb101-386"><a href="#cb101-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-389"><a href="#cb101-389" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-390"><a href="#cb101-390" aria-hidden="true" tabindex="-1"></a><span class="co"># For the polynomial regression we search the optimal degree with cross validation cv=5</span></span>
<span id="cb101-391"><a href="#cb101-391" aria-hidden="true" tabindex="-1"></a>cv_error <span class="op">=</span> np.zeros(<span class="dv">11</span>)</span>
<span id="cb101-392"><a href="#cb101-392" aria-hidden="true" tabindex="-1"></a>Hm <span class="op">=</span> np.array(horsepower)</span>
<span id="cb101-393"><a href="#cb101-393" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> sklearn_sm(sm.OLS)</span>
<span id="cb101-394"><a href="#cb101-394" aria-hidden="true" tabindex="-1"></a><span class="co">#Let's introduce splits. </span></span>
<span id="cb101-395"><a href="#cb101-395" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> KFold(n_splits<span class="op">=</span><span class="dv">5</span>,shuffle<span class="op">=</span><span class="va">True</span>,random_state<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb101-396"><a href="#cb101-396" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, d <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">12</span>)):</span>
<span id="cb101-397"><a href="#cb101-397" aria-hidden="true" tabindex="-1"></a>    Xcrossm <span class="op">=</span> np.power.outer(Hm, np.arange(d<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb101-398"><a href="#cb101-398" aria-hidden="true" tabindex="-1"></a>    Mat_CV <span class="op">=</span> cross_validate(M,Xcrossm,mpg,cv<span class="op">=</span>cv)</span>
<span id="cb101-399"><a href="#cb101-399" aria-hidden="true" tabindex="-1"></a>    cv_error[i] <span class="op">=</span> np.mean(Mat_CV[<span class="st">'test_score'</span>])</span>
<span id="cb101-400"><a href="#cb101-400" aria-hidden="true" tabindex="-1"></a>cv_error</span>
<span id="cb101-401"><a href="#cb101-401" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-402"><a href="#cb101-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-403"><a href="#cb101-403" aria-hidden="true" tabindex="-1"></a>The cross validation error is minimal where the polynomial degree equals 7.</span>
<span id="cb101-404"><a href="#cb101-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-407"><a href="#cb101-407" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-408"><a href="#cb101-408" aria-hidden="true" tabindex="-1"></a><span class="co"># define a grid of 100 points over which we can compute model predictions </span></span>
<span id="cb101-409"><a href="#cb101-409" aria-hidden="true" tabindex="-1"></a>horse_grid <span class="op">=</span> np.linspace(horsepower.<span class="bu">min</span>(), horsepower.<span class="bu">max</span>(), <span class="dv">100</span>)</span>
<span id="cb101-410"><a href="#cb101-410" aria-hidden="true" tabindex="-1"></a>horse_df<span class="op">=</span>pd.DataFrame({<span class="st">'horsepower'</span>:horse_grid})</span>
<span id="cb101-411"><a href="#cb101-411" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-412"><a href="#cb101-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-415"><a href="#cb101-415" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-416"><a href="#cb101-416" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_mpg_fit(horse_df, basis, title):</span>
<span id="cb101-417"><a href="#cb101-417" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" Function which returns the plot of the fitted polynomial model"""</span></span>
<span id="cb101-418"><a href="#cb101-418" aria-hidden="true" tabindex="-1"></a>    X1 <span class="op">=</span> basis.transform(Auto)</span>
<span id="cb101-419"><a href="#cb101-419" aria-hidden="true" tabindex="-1"></a>    Xnew1 <span class="op">=</span> basis.transform(horse_df)</span>
<span id="cb101-420"><a href="#cb101-420" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> sm.OLS(mpg, X1).fit()</span>
<span id="cb101-421"><a href="#cb101-421" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> M.get_prediction(Xnew1)</span>
<span id="cb101-422"><a href="#cb101-422" aria-hidden="true" tabindex="-1"></a>    bands <span class="op">=</span> preds.conf_int(alpha<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb101-423"><a href="#cb101-423" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb101-424"><a href="#cb101-424" aria-hidden="true" tabindex="-1"></a>    ax.scatter(horsepower,mpg,facecolor<span class="op">=</span><span class="st">'gray'</span>,alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb101-425"><a href="#cb101-425" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> val, ls <span class="kw">in</span> <span class="bu">zip</span>([preds.predicted_mean,bands[:,<span class="dv">0</span>],bands[:,<span class="dv">1</span>]],[<span class="st">'b'</span>,<span class="st">'r--'</span>,<span class="st">'r--'</span>]):</span>
<span id="cb101-426"><a href="#cb101-426" aria-hidden="true" tabindex="-1"></a>        ax.plot(horse_df.values, val, ls, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb101-427"><a href="#cb101-427" aria-hidden="true" tabindex="-1"></a>    ax.set_title(title, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb101-428"><a href="#cb101-428" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'Horsepower'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb101-429"><a href="#cb101-429" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'mpg'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb101-430"><a href="#cb101-430" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span>
<span id="cb101-431"><a href="#cb101-431" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-432"><a href="#cb101-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-435"><a href="#cb101-435" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-436"><a href="#cb101-436" aria-hidden="true" tabindex="-1"></a>model7<span class="op">=</span>MS([poly(<span class="st">'horsepower'</span>, degree<span class="op">=</span><span class="dv">7</span>)]).fit(Auto)</span>
<span id="cb101-437"><a href="#cb101-437" aria-hidden="true" tabindex="-1"></a>plot_mpg_fit(horse_df, model7, <span class="st">'7 degree polynomial'</span>)<span class="op">;</span></span>
<span id="cb101-438"><a href="#cb101-438" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-439"><a href="#cb101-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-442"><a href="#cb101-442" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-443"><a href="#cb101-443" aria-hidden="true" tabindex="-1"></a>X1 <span class="op">=</span> model7.transform(Auto)</span>
<span id="cb101-444"><a href="#cb101-444" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> sm.OLS(mpg, X1).fit()</span>
<span id="cb101-445"><a href="#cb101-445" aria-hidden="true" tabindex="-1"></a>summarize(M)</span>
<span id="cb101-446"><a href="#cb101-446" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-447"><a href="#cb101-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-448"><a href="#cb101-448" aria-hidden="true" tabindex="-1"></a>We notice that pvalue of degree 7 is not sigificant and the graph is wiggly. This implies that the best polynomial model has 6 degrees, which means that we have to refit the model using the same approach as above.</span>
<span id="cb101-449"><a href="#cb101-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-452"><a href="#cb101-452" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-453"><a href="#cb101-453" aria-hidden="true" tabindex="-1"></a><span class="co"># Step function model. First, let's try to find the optimal number of cuts</span></span>
<span id="cb101-454"><a href="#cb101-454" aria-hidden="true" tabindex="-1"></a><span class="co">#We'll use for that cross validation approach</span></span>
<span id="cb101-455"><a href="#cb101-455" aria-hidden="true" tabindex="-1"></a>cv_error_cuts <span class="op">=</span> np.zeros(<span class="dv">20</span>)</span>
<span id="cb101-456"><a href="#cb101-456" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, d <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">21</span>)):</span>
<span id="cb101-457"><a href="#cb101-457" aria-hidden="true" tabindex="-1"></a>    Xcross <span class="op">=</span> pd.qcut(horsepower, d<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb101-458"><a href="#cb101-458" aria-hidden="true" tabindex="-1"></a>    M_CV_cut <span class="op">=</span> cross_validate(sklearn_sm(sm.OLS),pd.get_dummies(Xcross),mpg,cv<span class="op">=</span>cv)</span>
<span id="cb101-459"><a href="#cb101-459" aria-hidden="true" tabindex="-1"></a>    cv_error_cuts[i] <span class="op">=</span> np.mean(M_CV_cut[<span class="st">'test_score'</span>])</span>
<span id="cb101-460"><a href="#cb101-460" aria-hidden="true" tabindex="-1"></a>cv_error_cuts</span>
<span id="cb101-461"><a href="#cb101-461" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-462"><a href="#cb101-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-463"><a href="#cb101-463" aria-hidden="true" tabindex="-1"></a>We deduce from the minimum cross validation error that the best number of cuts is 10.</span>
<span id="cb101-464"><a href="#cb101-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-467"><a href="#cb101-467" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-468"><a href="#cb101-468" aria-hidden="true" tabindex="-1"></a>n_cuts<span class="op">=</span><span class="dv">10</span></span>
<span id="cb101-469"><a href="#cb101-469" aria-hidden="true" tabindex="-1"></a>cut_horse <span class="op">=</span> pd.qcut(horsepower, n_cuts<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb101-470"><a href="#cb101-470" aria-hidden="true" tabindex="-1"></a><span class="co"># Get dummy features relatively to horsepower groups</span></span>
<span id="cb101-471"><a href="#cb101-471" aria-hidden="true" tabindex="-1"></a>dummy_horse<span class="op">=</span>pd.get_dummies(cut_horse)</span>
<span id="cb101-472"><a href="#cb101-472" aria-hidden="true" tabindex="-1"></a><span class="co">#Create a new data frame to fit the new model</span></span>
<span id="cb101-473"><a href="#cb101-473" aria-hidden="true" tabindex="-1"></a>dfh_step<span class="op">=</span>pd.concat([dummy_horse, mpg], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb101-474"><a href="#cb101-474" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign roles to each of the columns of the new data set and ft the model</span></span>
<span id="cb101-475"><a href="#cb101-475" aria-hidden="true" tabindex="-1"></a>Xnewh<span class="op">=</span>dfh_step.iloc[:,:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb101-476"><a href="#cb101-476" aria-hidden="true" tabindex="-1"></a>ynewh<span class="op">=</span>dfh_step.iloc[:,<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb101-477"><a href="#cb101-477" aria-hidden="true" tabindex="-1"></a>ynewhnp<span class="op">=</span>np.array(ynewh)[:,np.newaxis]</span>
<span id="cb101-478"><a href="#cb101-478" aria-hidden="true" tabindex="-1"></a>modelh_step<span class="op">=</span>MS(Xnewh,intercept<span class="op">=</span><span class="va">False</span>).fit(dfh_step)</span>
<span id="cb101-479"><a href="#cb101-479" aria-hidden="true" tabindex="-1"></a>Xh<span class="op">=</span>modelh_step.transform(dfh_step)</span>
<span id="cb101-480"><a href="#cb101-480" aria-hidden="true" tabindex="-1"></a>resh<span class="op">=</span>sm.OLS(ynewhnp,Xh).fit()</span>
<span id="cb101-481"><a href="#cb101-481" aria-hidden="true" tabindex="-1"></a><span class="co">#Define a gird over which we can plot predictions</span></span>
<span id="cb101-482"><a href="#cb101-482" aria-hidden="true" tabindex="-1"></a>Xh_grid<span class="op">=</span>np.linspace(horsepower.<span class="bu">min</span>(),horsepower.<span class="bu">max</span>())</span>
<span id="cb101-483"><a href="#cb101-483" aria-hidden="true" tabindex="-1"></a><span class="co">#Now let's cut the defined grid over the predifined groups. We use the cut function to create an</span></span>
<span id="cb101-484"><a href="#cb101-484" aria-hidden="true" tabindex="-1"></a><span class="co"># ordered set of values</span></span>
<span id="cb101-485"><a href="#cb101-485" aria-hidden="true" tabindex="-1"></a>groupsh <span class="op">=</span> pd.cut(Xh_grid, n_cuts<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb101-486"><a href="#cb101-486" aria-hidden="true" tabindex="-1"></a>dummiesh <span class="op">=</span> pd.get_dummies(groupsh)</span>
<span id="cb101-487"><a href="#cb101-487" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the step function </span></span>
<span id="cb101-488"><a href="#cb101-488" aria-hidden="true" tabindex="-1"></a>yh_step <span class="op">=</span> resh.predict(dummiesh)</span>
<span id="cb101-489"><a href="#cb101-489" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb101-490"><a href="#cb101-490" aria-hidden="true" tabindex="-1"></a>plt.scatter(horsepower,mpg)</span>
<span id="cb101-491"><a href="#cb101-491" aria-hidden="true" tabindex="-1"></a>plt.plot(Xh_grid, yh_step,<span class="st">'-r'</span>)</span>
<span id="cb101-492"><a href="#cb101-492" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Step function'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb101-493"><a href="#cb101-493" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Horsepower'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb101-494"><a href="#cb101-494" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'mpg'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb101-495"><a href="#cb101-495" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-496"><a href="#cb101-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-499"><a href="#cb101-499" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-500"><a href="#cb101-500" aria-hidden="true" tabindex="-1"></a>summarize(resh)</span>
<span id="cb101-501"><a href="#cb101-501" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-502"><a href="#cb101-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-503"><a href="#cb101-503" aria-hidden="true" tabindex="-1"></a>Obviously the step function looks wiggly. The polynomial regression seems to fit better the training model. </span>
<span id="cb101-504"><a href="#cb101-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-507"><a href="#cb101-507" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-508"><a href="#cb101-508" aria-hidden="true" tabindex="-1"></a><span class="co">#Natural cubic spline model. We could have used cross validation to determine the degrees of freedom.</span></span>
<span id="cb101-509"><a href="#cb101-509" aria-hidden="true" tabindex="-1"></a><span class="co"># But we assume here, as it is often the case, that there must be 6 since a cubic spline implies </span></span>
<span id="cb101-510"><a href="#cb101-510" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 degrees along with 2 more constraints to add at the ends.</span></span>
<span id="cb101-511"><a href="#cb101-511" aria-hidden="true" tabindex="-1"></a>ns_horse <span class="op">=</span> MS([ns(<span class="st">'horsepower'</span>, df<span class="op">=</span><span class="dv">6</span>)]).fit(Auto)</span>
<span id="cb101-512"><a href="#cb101-512" aria-hidden="true" tabindex="-1"></a>M_nsh <span class="op">=</span> sm.OLS(mpg, ns_horse.transform(Auto)).fit()</span>
<span id="cb101-513"><a href="#cb101-513" aria-hidden="true" tabindex="-1"></a>summarize(M_nsh)</span>
<span id="cb101-514"><a href="#cb101-514" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-515"><a href="#cb101-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-518"><a href="#cb101-518" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-519"><a href="#cb101-519" aria-hidden="true" tabindex="-1"></a>plot_mpg_fit(horse_df, ns_horse,<span class="st">'Natural spline, df=6'</span>)<span class="op">;</span></span>
<span id="cb101-520"><a href="#cb101-520" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-521"><a href="#cb101-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-522"><a href="#cb101-522" aria-hidden="true" tabindex="-1"></a>All the coefficients are significant and the confidence intervals plots at the ends look stable.</span>
<span id="cb101-523"><a href="#cb101-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-524"><a href="#cb101-524" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercise 9</span></span>
<span id="cb101-525"><a href="#cb101-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-528"><a href="#cb101-528" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-529"><a href="#cb101-529" aria-hidden="true" tabindex="-1"></a>Boston<span class="op">=</span>load_data(<span class="st">'Boston'</span>)</span>
<span id="cb101-530"><a href="#cb101-530" aria-hidden="true" tabindex="-1"></a>dis<span class="op">=</span>Boston[<span class="st">'dis'</span>]</span>
<span id="cb101-531"><a href="#cb101-531" aria-hidden="true" tabindex="-1"></a>nox<span class="op">=</span>Boston[<span class="st">'nox'</span>]</span>
<span id="cb101-532"><a href="#cb101-532" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-533"><a href="#cb101-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-534"><a href="#cb101-534" aria-hidden="true" tabindex="-1"></a><span class="fu">### (a)</span></span>
<span id="cb101-535"><a href="#cb101-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-538"><a href="#cb101-538" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-539"><a href="#cb101-539" aria-hidden="true" tabindex="-1"></a>model3<span class="op">=</span>MS([poly(<span class="st">'dis'</span>, degree<span class="op">=</span><span class="dv">3</span>)]).fit(Boston)</span>
<span id="cb101-540"><a href="#cb101-540" aria-hidden="true" tabindex="-1"></a>X<span class="op">=</span>model3.transform(Boston)</span>
<span id="cb101-541"><a href="#cb101-541" aria-hidden="true" tabindex="-1"></a>res<span class="op">=</span>sm.OLS(nox, X).fit()</span>
<span id="cb101-542"><a href="#cb101-542" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-543"><a href="#cb101-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-546"><a href="#cb101-546" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-547"><a href="#cb101-547" aria-hidden="true" tabindex="-1"></a>summarize(res)</span>
<span id="cb101-548"><a href="#cb101-548" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-549"><a href="#cb101-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-552"><a href="#cb101-552" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-553"><a href="#cb101-553" aria-hidden="true" tabindex="-1"></a><span class="co">#Define the grid of predictor values</span></span>
<span id="cb101-554"><a href="#cb101-554" aria-hidden="true" tabindex="-1"></a>dis_grid <span class="op">=</span> np.linspace(dis.<span class="bu">min</span>(), dis.<span class="bu">max</span>(), <span class="dv">100</span>)</span>
<span id="cb101-555"><a href="#cb101-555" aria-hidden="true" tabindex="-1"></a>dis_df<span class="op">=</span>pd.DataFrame({<span class="st">'dis'</span>:dis_grid})</span>
<span id="cb101-556"><a href="#cb101-556" aria-hidden="true" tabindex="-1"></a>dis2_df<span class="op">=</span>pd.DataFrame({<span class="st">'dis'</span>:dis})</span>
<span id="cb101-557"><a href="#cb101-557" aria-hidden="true" tabindex="-1"></a><span class="co">#Plot the results</span></span>
<span id="cb101-558"><a href="#cb101-558" aria-hidden="true" tabindex="-1"></a>Xnew2<span class="op">=</span>model3.transform(dis_df)</span>
<span id="cb101-559"><a href="#cb101-559" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> res.get_prediction(Xnew2)</span>
<span id="cb101-560"><a href="#cb101-560" aria-hidden="true" tabindex="-1"></a>bands <span class="op">=</span> preds.conf_int(alpha<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb101-561"><a href="#cb101-561" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb101-562"><a href="#cb101-562" aria-hidden="true" tabindex="-1"></a>ax.scatter(dis,nox,facecolor<span class="op">=</span><span class="st">'gray'</span>,alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb101-563"><a href="#cb101-563" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> val, ls <span class="kw">in</span> <span class="bu">zip</span>([preds.predicted_mean,bands[:,<span class="dv">0</span>],bands[:,<span class="dv">1</span>]],[<span class="st">'b'</span>,<span class="st">'r--'</span>,<span class="st">'r--'</span>]):</span>
<span id="cb101-564"><a href="#cb101-564" aria-hidden="true" tabindex="-1"></a>        ax.plot(dis_df.values, val, ls, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb101-565"><a href="#cb101-565" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Cubic polynomial regression of nox on dis'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb101-566"><a href="#cb101-566" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'dis'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb101-567"><a href="#cb101-567" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'nox'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb101-568"><a href="#cb101-568" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-569"><a href="#cb101-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-572"><a href="#cb101-572" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-573"><a href="#cb101-573" aria-hidden="true" tabindex="-1"></a>preds<span class="op">=</span>preds.predicted_mean.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb101-574"><a href="#cb101-574" aria-hidden="true" tabindex="-1"></a>preds.shape</span>
<span id="cb101-575"><a href="#cb101-575" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-576"><a href="#cb101-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-577"><a href="#cb101-577" aria-hidden="true" tabindex="-1"></a><span class="fu">### (b)</span></span>
<span id="cb101-578"><a href="#cb101-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-581"><a href="#cb101-581" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-582"><a href="#cb101-582" aria-hidden="true" tabindex="-1"></a>RSS<span class="op">=</span>{}</span>
<span id="cb101-583"><a href="#cb101-583" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">11</span>):</span>
<span id="cb101-584"><a href="#cb101-584" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>MS([poly(<span class="st">'dis'</span>, degree<span class="op">=</span>d)]).fit(Boston)</span>
<span id="cb101-585"><a href="#cb101-585" aria-hidden="true" tabindex="-1"></a>    X<span class="op">=</span>model.transform(Boston)</span>
<span id="cb101-586"><a href="#cb101-586" aria-hidden="true" tabindex="-1"></a>    res<span class="op">=</span>sm.OLS(nox, X).fit()</span>
<span id="cb101-587"><a href="#cb101-587" aria-hidden="true" tabindex="-1"></a>    Xnew<span class="op">=</span>model.transform(dis_df)</span>
<span id="cb101-588"><a href="#cb101-588" aria-hidden="true" tabindex="-1"></a>    Xnew2<span class="op">=</span>model.transform(dis2_df)</span>
<span id="cb101-589"><a href="#cb101-589" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> res.get_prediction(Xnew)</span>
<span id="cb101-590"><a href="#cb101-590" aria-hidden="true" tabindex="-1"></a>    yhat<span class="op">=</span>res.get_prediction(Xnew2)</span>
<span id="cb101-591"><a href="#cb101-591" aria-hidden="true" tabindex="-1"></a>    yhat<span class="op">=</span>yhat.predicted_mean</span>
<span id="cb101-592"><a href="#cb101-592" aria-hidden="true" tabindex="-1"></a>    RSS[d]<span class="op">=</span>np.<span class="bu">sum</span>((nox <span class="op">-</span> yhat)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb101-593"><a href="#cb101-593" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb101-594"><a href="#cb101-594" aria-hidden="true" tabindex="-1"></a>    ax.scatter(dis,nox,facecolor<span class="op">=</span><span class="st">'gray'</span>,alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb101-595"><a href="#cb101-595" aria-hidden="true" tabindex="-1"></a>    ax.plot(dis_df.values,preds.predicted_mean , <span class="st">'b'</span>, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb101-596"><a href="#cb101-596" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Polynomial regression of nox on dis with degree='</span><span class="op">+</span> <span class="bu">str</span>(d), fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb101-597"><a href="#cb101-597" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'dis'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb101-598"><a href="#cb101-598" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'nox'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb101-599"><a href="#cb101-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-600"><a href="#cb101-600" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-601"><a href="#cb101-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-604"><a href="#cb101-604" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-605"><a href="#cb101-605" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(RSS,index <span class="op">=</span> [<span class="st">'RSS'</span>]).T</span>
<span id="cb101-606"><a href="#cb101-606" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-607"><a href="#cb101-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-608"><a href="#cb101-608" aria-hidden="true" tabindex="-1"></a>As expected, the training RSE decreases with the polynomial degree.</span>
<span id="cb101-609"><a href="#cb101-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-610"><a href="#cb101-610" aria-hidden="true" tabindex="-1"></a><span class="fu">### (c)</span></span>
<span id="cb101-611"><a href="#cb101-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-614"><a href="#cb101-614" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-615"><a href="#cb101-615" aria-hidden="true" tabindex="-1"></a><span class="co"># Using cross validation to find the best polynomial degree. cv=5</span></span>
<span id="cb101-616"><a href="#cb101-616" aria-hidden="true" tabindex="-1"></a>cv_error <span class="op">=</span> np.zeros(<span class="dv">11</span>)</span>
<span id="cb101-617"><a href="#cb101-617" aria-hidden="true" tabindex="-1"></a>H <span class="op">=</span> np.array(dis)</span>
<span id="cb101-618"><a href="#cb101-618" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> sklearn_sm(sm.OLS)</span>
<span id="cb101-619"><a href="#cb101-619" aria-hidden="true" tabindex="-1"></a><span class="co">#Let's introduce splits. </span></span>
<span id="cb101-620"><a href="#cb101-620" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> KFold(n_splits<span class="op">=</span><span class="dv">5</span>,shuffle<span class="op">=</span><span class="va">True</span>,random_state<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb101-621"><a href="#cb101-621" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, d <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">12</span>)):</span>
<span id="cb101-622"><a href="#cb101-622" aria-hidden="true" tabindex="-1"></a>    Xcross <span class="op">=</span> np.power.outer(H, np.arange(d<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb101-623"><a href="#cb101-623" aria-hidden="true" tabindex="-1"></a>    Mat_CV <span class="op">=</span> cross_validate(M,Xcross,nox,cv<span class="op">=</span>cv)</span>
<span id="cb101-624"><a href="#cb101-624" aria-hidden="true" tabindex="-1"></a>    cv_error[i] <span class="op">=</span> np.mean(Mat_CV[<span class="st">'test_score'</span>])</span>
<span id="cb101-625"><a href="#cb101-625" aria-hidden="true" tabindex="-1"></a>cv_error</span>
<span id="cb101-626"><a href="#cb101-626" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-627"><a href="#cb101-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-628"><a href="#cb101-628" aria-hidden="true" tabindex="-1"></a>The optimal polynomial regression is obtained for 3 degrees.</span>
<span id="cb101-629"><a href="#cb101-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-630"><a href="#cb101-630" aria-hidden="true" tabindex="-1"></a><span class="fu">### (d)</span></span>
<span id="cb101-631"><a href="#cb101-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-634"><a href="#cb101-634" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-635"><a href="#cb101-635" aria-hidden="true" tabindex="-1"></a>bs_dis <span class="op">=</span> MS([bs(<span class="st">'dis'</span>, df<span class="op">=</span><span class="dv">4</span>)]).fit(Boston)</span>
<span id="cb101-636"><a href="#cb101-636" aria-hidden="true" tabindex="-1"></a>M_bs <span class="op">=</span> sm.OLS(nox, bs_dis.transform(Boston)).fit()</span>
<span id="cb101-637"><a href="#cb101-637" aria-hidden="true" tabindex="-1"></a>summarize(M_bs)</span>
<span id="cb101-638"><a href="#cb101-638" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-639"><a href="#cb101-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-642"><a href="#cb101-642" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-643"><a href="#cb101-643" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> bs_dis.transform(Boston)</span>
<span id="cb101-644"><a href="#cb101-644" aria-hidden="true" tabindex="-1"></a>Xnew <span class="op">=</span> bs_dis.transform(dis_df)</span>
<span id="cb101-645"><a href="#cb101-645" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> sm.OLS(nox, X).fit()</span>
<span id="cb101-646"><a href="#cb101-646" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> M.get_prediction(Xnew)</span>
<span id="cb101-647"><a href="#cb101-647" aria-hidden="true" tabindex="-1"></a>bands <span class="op">=</span> preds.conf_int(alpha<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb101-648"><a href="#cb101-648" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb101-649"><a href="#cb101-649" aria-hidden="true" tabindex="-1"></a>ax.scatter(dis,nox,facecolor<span class="op">=</span><span class="st">'gray'</span>,alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb101-650"><a href="#cb101-650" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> val, ls <span class="kw">in</span> <span class="bu">zip</span>([preds.predicted_mean,bands[:,<span class="dv">0</span>],bands[:,<span class="dv">1</span>]],[<span class="st">'b'</span>,<span class="st">'r--'</span>,<span class="st">'r--'</span>]):</span>
<span id="cb101-651"><a href="#cb101-651" aria-hidden="true" tabindex="-1"></a>        ax.plot(dis_df.values, val, ls, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb101-652"><a href="#cb101-652" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Regression spline fit of nox on dis with 4 df'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb101-653"><a href="#cb101-653" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'dis'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb101-654"><a href="#cb101-654" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'nox'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb101-655"><a href="#cb101-655" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-656"><a href="#cb101-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-657"><a href="#cb101-657" aria-hidden="true" tabindex="-1"></a>The knots were automatically chosen as the four quartiles.</span>
<span id="cb101-658"><a href="#cb101-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-659"><a href="#cb101-659" aria-hidden="true" tabindex="-1"></a><span class="fu">### (e)</span></span>
<span id="cb101-660"><a href="#cb101-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-663"><a href="#cb101-663" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-664"><a href="#cb101-664" aria-hidden="true" tabindex="-1"></a>RSS<span class="op">=</span>{}</span>
<span id="cb101-665"><a href="#cb101-665" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>,<span class="dv">11</span>):</span>
<span id="cb101-666"><a href="#cb101-666" aria-hidden="true" tabindex="-1"></a>    bs_dis <span class="op">=</span> MS([bs(<span class="st">'dis'</span>, df<span class="op">=</span>d)]).fit(Boston)</span>
<span id="cb101-667"><a href="#cb101-667" aria-hidden="true" tabindex="-1"></a>    M_bs <span class="op">=</span> sm.OLS(nox, bs_dis.transform(Boston)).fit()</span>
<span id="cb101-668"><a href="#cb101-668" aria-hidden="true" tabindex="-1"></a>    Xnew <span class="op">=</span> bs_dis.transform(dis_df)</span>
<span id="cb101-669"><a href="#cb101-669" aria-hidden="true" tabindex="-1"></a>    Xnew2<span class="op">=</span>bs_dis.transform(dis2_df)</span>
<span id="cb101-670"><a href="#cb101-670" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> M_bs.get_prediction(Xnew)</span>
<span id="cb101-671"><a href="#cb101-671" aria-hidden="true" tabindex="-1"></a>    yhat<span class="op">=</span>M_bs.get_prediction(Xnew2)</span>
<span id="cb101-672"><a href="#cb101-672" aria-hidden="true" tabindex="-1"></a>    yhat<span class="op">=</span>yhat.predicted_mean</span>
<span id="cb101-673"><a href="#cb101-673" aria-hidden="true" tabindex="-1"></a>    RSS[d]<span class="op">=</span>np.<span class="bu">sum</span>((nox <span class="op">-</span> yhat)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb101-674"><a href="#cb101-674" aria-hidden="true" tabindex="-1"></a>    bands <span class="op">=</span> preds.conf_int(alpha<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb101-675"><a href="#cb101-675" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb101-676"><a href="#cb101-676" aria-hidden="true" tabindex="-1"></a>    ax.scatter(dis,nox,facecolor<span class="op">=</span><span class="st">'gray'</span>,alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb101-677"><a href="#cb101-677" aria-hidden="true" tabindex="-1"></a>    ax.plot(dis_df.values, preds.predicted_mean, <span class="st">'b'</span>, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb101-678"><a href="#cb101-678" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Regression spline fit of nox on dis with df='</span><span class="op">+</span><span class="bu">str</span>(d), fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb101-679"><a href="#cb101-679" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'dis'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb101-680"><a href="#cb101-680" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'nox'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb101-681"><a href="#cb101-681" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-682"><a href="#cb101-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-685"><a href="#cb101-685" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-686"><a href="#cb101-686" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(RSS,index <span class="op">=</span> [<span class="st">'RSS'</span>]).T</span>
<span id="cb101-687"><a href="#cb101-687" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-688"><a href="#cb101-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-689"><a href="#cb101-689" aria-hidden="true" tabindex="-1"></a>The training RSS decreases with degrees of freedom. We cannot decide which is the best regression spline model.</span>
<span id="cb101-690"><a href="#cb101-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-691"><a href="#cb101-691" aria-hidden="true" tabindex="-1"></a><span class="fu">### (f)</span></span>
<span id="cb101-692"><a href="#cb101-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-695"><a href="#cb101-695" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-696"><a href="#cb101-696" aria-hidden="true" tabindex="-1"></a><span class="co"># Using cross validation to find the best regression spline model. cv=10</span></span>
<span id="cb101-697"><a href="#cb101-697" aria-hidden="true" tabindex="-1"></a>cv_error <span class="op">=</span> np.zeros(<span class="dv">9</span>)</span>
<span id="cb101-698"><a href="#cb101-698" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> sklearn_sm(sm.OLS)</span>
<span id="cb101-699"><a href="#cb101-699" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> KFold(n_splits<span class="op">=</span><span class="dv">10</span>,shuffle<span class="op">=</span><span class="va">True</span>,random_state<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb101-700"><a href="#cb101-700" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>,<span class="dv">12</span>):</span>
<span id="cb101-701"><a href="#cb101-701" aria-hidden="true" tabindex="-1"></a>    bs_dis <span class="op">=</span> MS([bs(<span class="st">'dis'</span>, df<span class="op">=</span>d)]).fit(Boston)</span>
<span id="cb101-702"><a href="#cb101-702" aria-hidden="true" tabindex="-1"></a>    Xcross <span class="op">=</span> bs_dis.transform(Boston)</span>
<span id="cb101-703"><a href="#cb101-703" aria-hidden="true" tabindex="-1"></a>    Mat_CV <span class="op">=</span> cross_validate(M,Xcross,nox,cv<span class="op">=</span>cv)</span>
<span id="cb101-704"><a href="#cb101-704" aria-hidden="true" tabindex="-1"></a>    cv_error[d<span class="op">-</span><span class="dv">3</span>] <span class="op">=</span> np.mean(Mat_CV[<span class="st">'test_score'</span>])</span>
<span id="cb101-705"><a href="#cb101-705" aria-hidden="true" tabindex="-1"></a>cv_error</span>
<span id="cb101-706"><a href="#cb101-706" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-707"><a href="#cb101-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-708"><a href="#cb101-708" aria-hidden="true" tabindex="-1"></a>The optimal model is obtained for 5 degrees of freedom but results seem unstable. Another approach like ANOVA can be more useful to spot the best model.</span>
<span id="cb101-709"><a href="#cb101-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-710"><a href="#cb101-710" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercise 10</span></span>
<span id="cb101-711"><a href="#cb101-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-714"><a href="#cb101-714" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-715"><a href="#cb101-715" aria-hidden="true" tabindex="-1"></a>College<span class="op">=</span>load_data(<span class="st">'College'</span>)</span>
<span id="cb101-716"><a href="#cb101-716" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-717"><a href="#cb101-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-718"><a href="#cb101-718" aria-hidden="true" tabindex="-1"></a><span class="fu">### (a)</span></span>
<span id="cb101-719"><a href="#cb101-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-722"><a href="#cb101-722" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-723"><a href="#cb101-723" aria-hidden="true" tabindex="-1"></a>College_train, College_valid <span class="op">=</span> train_test_split(College, test_size<span class="op">=</span><span class="fl">0.5</span>, random_state<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb101-724"><a href="#cb101-724" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-725"><a href="#cb101-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-728"><a href="#cb101-728" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-729"><a href="#cb101-729" aria-hidden="true" tabindex="-1"></a>College[<span class="st">'Private'</span>]<span class="op">=</span>College[<span class="st">'Private'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb101-730"><a href="#cb101-730" aria-hidden="true" tabindex="-1"></a>College_train[<span class="st">'Private'</span>]<span class="op">=</span>College_train[<span class="st">'Private'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb101-731"><a href="#cb101-731" aria-hidden="true" tabindex="-1"></a>College_valid[<span class="st">'Private'</span>]<span class="op">=</span>College_valid[<span class="st">'Private'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb101-732"><a href="#cb101-732" aria-hidden="true" tabindex="-1"></a>y<span class="op">=</span>College_train[<span class="st">'Outstate'</span>]</span>
<span id="cb101-733"><a href="#cb101-733" aria-hidden="true" tabindex="-1"></a>Vars_train <span class="op">=</span> College_train.columns.drop([<span class="st">'Outstate'</span>])</span>
<span id="cb101-734"><a href="#cb101-734" aria-hidden="true" tabindex="-1"></a>design<span class="op">=</span>MS(Vars_train).fit(College_train)</span>
<span id="cb101-735"><a href="#cb101-735" aria-hidden="true" tabindex="-1"></a>X_train<span class="op">=</span>design.transform(College_train)</span>
<span id="cb101-736"><a href="#cb101-736" aria-hidden="true" tabindex="-1"></a>College_train.info()</span>
<span id="cb101-737"><a href="#cb101-737" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-738"><a href="#cb101-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-741"><a href="#cb101-741" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-742"><a href="#cb101-742" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the scoring system based on Cp coefficient</span></span>
<span id="cb101-743"><a href="#cb101-743" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> nCp(sigma2, estimator, X, Y):</span>
<span id="cb101-744"><a href="#cb101-744" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Negative Cp statistic"</span></span>
<span id="cb101-745"><a href="#cb101-745" aria-hidden="true" tabindex="-1"></a>    n, p <span class="op">=</span> X.shape</span>
<span id="cb101-746"><a href="#cb101-746" aria-hidden="true" tabindex="-1"></a>    Yhat <span class="op">=</span> estimator.predict(X)</span>
<span id="cb101-747"><a href="#cb101-747" aria-hidden="true" tabindex="-1"></a>    RSS <span class="op">=</span> np.<span class="bu">sum</span>((Y <span class="op">-</span> Yhat)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb101-748"><a href="#cb101-748" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>(RSS <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> p <span class="op">*</span> sigma2) <span class="op">/</span> n </span>
<span id="cb101-749"><a href="#cb101-749" aria-hidden="true" tabindex="-1"></a>design_sigma <span class="op">=</span> MS(College.columns.drop(<span class="st">'Outstate'</span>)).fit(College)</span>
<span id="cb101-750"><a href="#cb101-750" aria-hidden="true" tabindex="-1"></a>Y_sigma <span class="op">=</span> np.array(College[<span class="st">'Outstate'</span>])</span>
<span id="cb101-751"><a href="#cb101-751" aria-hidden="true" tabindex="-1"></a>X_sigma <span class="op">=</span> design_sigma.transform(College)</span>
<span id="cb101-752"><a href="#cb101-752" aria-hidden="true" tabindex="-1"></a>sigma2 <span class="op">=</span> OLS(Y_sigma,X_sigma).fit().scale</span>
<span id="cb101-753"><a href="#cb101-753" aria-hidden="true" tabindex="-1"></a>neg_Cp <span class="op">=</span> partial(nCp, sigma2)</span>
<span id="cb101-754"><a href="#cb101-754" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-755"><a href="#cb101-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-758"><a href="#cb101-758" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-759"><a href="#cb101-759" aria-hidden="true" tabindex="-1"></a>strategy<span class="op">=</span>Stepwise.first_peak(design,direction<span class="op">=</span><span class="st">'forward'</span>,max_terms<span class="op">=</span><span class="bu">len</span>(design.terms))</span>
<span id="cb101-760"><a href="#cb101-760" aria-hidden="true" tabindex="-1"></a>Outstate_MSE <span class="op">=</span> sklearn_selected(OLS,strategy,scoring<span class="op">=</span>neg_Cp)</span>
<span id="cb101-761"><a href="#cb101-761" aria-hidden="true" tabindex="-1"></a>Outstate_MSE.fit(College_train, y)</span>
<span id="cb101-762"><a href="#cb101-762" aria-hidden="true" tabindex="-1"></a>Outstate_MSE.selected_state_</span>
<span id="cb101-763"><a href="#cb101-763" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-764"><a href="#cb101-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-765"><a href="#cb101-765" aria-hidden="true" tabindex="-1"></a>The optimization of Cp coefficient shows that the best model obtained by forward stepwise selection relies on 10 predictors.</span>
<span id="cb101-766"><a href="#cb101-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-767"><a href="#cb101-767" aria-hidden="true" tabindex="-1"></a><span class="fu">### (b)</span></span>
<span id="cb101-768"><a href="#cb101-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-771"><a href="#cb101-771" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-772"><a href="#cb101-772" aria-hidden="true" tabindex="-1"></a>gam <span class="op">=</span> LinearGAM(s_gam(<span class="dv">0</span>)<span class="op">+</span> s_gam(<span class="dv">1</span>)<span class="op">+</span>s_gam(<span class="dv">2</span>)<span class="op">+</span>s_gam(<span class="dv">3</span>)<span class="op">+</span>s_gam(<span class="dv">4</span>)<span class="op">+</span> f_gam(<span class="dv">5</span>, lam<span class="op">=</span><span class="dv">0</span>) </span>
<span id="cb101-773"><a href="#cb101-773" aria-hidden="true" tabindex="-1"></a>                <span class="op">+</span>s_gam(<span class="dv">6</span>)<span class="op">+</span>s_gam(<span class="dv">7</span>)<span class="op">+</span>s_gam(<span class="dv">8</span>)<span class="op">+</span>s_gam(<span class="dv">9</span>))</span>
<span id="cb101-774"><a href="#cb101-774" aria-hidden="true" tabindex="-1"></a>Xgam <span class="op">=</span> np.column_stack([College_train[<span class="st">'Accept'</span>],College_train[<span class="st">'Expend'</span>],College_train[<span class="st">'F.Undergrad'</span>],College_train[<span class="st">'Grad.Rate'</span>],</span>
<span id="cb101-775"><a href="#cb101-775" aria-hidden="true" tabindex="-1"></a>                        College_train[<span class="st">'Personal'</span>], College_train[<span class="st">'Private'</span>].cat.codes,College_train[<span class="st">'Room.Board'</span>],</span>
<span id="cb101-776"><a href="#cb101-776" aria-hidden="true" tabindex="-1"></a>                        College_train[<span class="st">'Terminal'</span>],College_train[<span class="st">'Top10perc'</span>],College_train[<span class="st">'perc.alumni'</span>]])</span>
<span id="cb101-777"><a href="#cb101-777" aria-hidden="true" tabindex="-1"></a>gam <span class="op">=</span> gam.fit(Xgam, y)</span>
<span id="cb101-778"><a href="#cb101-778" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-779"><a href="#cb101-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-782"><a href="#cb101-782" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-783"><a href="#cb101-783" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> d <span class="kw">in</span> Outstate_MSE.selected_state_:</span>
<span id="cb101-784"><a href="#cb101-784" aria-hidden="true" tabindex="-1"></a>    i<span class="op">=</span>Outstate_MSE.selected_state_.index(d)</span>
<span id="cb101-785"><a href="#cb101-785" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb101-786"><a href="#cb101-786" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> plot_gam(gam, i)</span>
<span id="cb101-787"><a href="#cb101-787" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(d)</span>
<span id="cb101-788"><a href="#cb101-788" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Effect on Outstate tuition'</span>)</span>
<span id="cb101-789"><a href="#cb101-789" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Partial dependence of Outstate tuition on '</span><span class="op">+</span>d,fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb101-790"><a href="#cb101-790" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-791"><a href="#cb101-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-792"><a href="#cb101-792" aria-hidden="true" tabindex="-1"></a>Some of the graphs represented above display wiggly splines (e.g Outstate tuition on Terminal) which puts the gam model considered before into question.</span>
<span id="cb101-793"><a href="#cb101-793" aria-hidden="true" tabindex="-1"></a>In order to select the best GAM model we should consider the aformentionned cases and alternate between linear spline choices.</span>
<span id="cb101-794"><a href="#cb101-794" aria-hidden="true" tabindex="-1"></a>The comparison of obtained models can be done using ANOVA</span>
<span id="cb101-795"><a href="#cb101-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-796"><a href="#cb101-796" aria-hidden="true" tabindex="-1"></a>We choose to experiment with the following features due the roughness of their splines shown on the previous graphs: 'perc.alumni', 'Room.Board' and 'Grad.Rate'.</span>
<span id="cb101-797"><a href="#cb101-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-800"><a href="#cb101-800" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-801"><a href="#cb101-801" aria-hidden="true" tabindex="-1"></a>gam2 <span class="op">=</span> LinearGAM(s_gam(<span class="dv">0</span>)<span class="op">+</span> s_gam(<span class="dv">1</span>)<span class="op">+</span>s_gam(<span class="dv">2</span>)<span class="op">+</span>l_gam(<span class="dv">3</span>)<span class="op">+</span>s_gam(<span class="dv">4</span>)<span class="op">+</span> f_gam(<span class="dv">5</span>, lam<span class="op">=</span><span class="dv">0</span>) </span>
<span id="cb101-802"><a href="#cb101-802" aria-hidden="true" tabindex="-1"></a>                <span class="op">+</span>l_gam(<span class="dv">6</span>)<span class="op">+</span>s_gam(<span class="dv">7</span>)<span class="op">+</span>s_gam(<span class="dv">8</span>)<span class="op">+</span>l_gam(<span class="dv">9</span>))</span>
<span id="cb101-803"><a href="#cb101-803" aria-hidden="true" tabindex="-1"></a>gam2 <span class="op">=</span> gam2.fit(Xgam, y)</span>
<span id="cb101-804"><a href="#cb101-804" aria-hidden="true" tabindex="-1"></a>anova_gam(gam2,gam)</span>
<span id="cb101-805"><a href="#cb101-805" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-806"><a href="#cb101-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-807"><a href="#cb101-807" aria-hidden="true" tabindex="-1"></a>The above table shows that 'gam' model is no better than the second. Hence gam2 is adopted for the rest of the exercise.</span>
<span id="cb101-808"><a href="#cb101-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-809"><a href="#cb101-809" aria-hidden="true" tabindex="-1"></a><span class="fu">### (c)</span></span>
<span id="cb101-810"><a href="#cb101-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-813"><a href="#cb101-813" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-814"><a href="#cb101-814" aria-hidden="true" tabindex="-1"></a>y_test<span class="op">=</span>College_valid[<span class="st">'Outstate'</span>]</span>
<span id="cb101-815"><a href="#cb101-815" aria-hidden="true" tabindex="-1"></a><span class="co">#vars_test=College_valid.columns.drop(['Outstate'])</span></span>
<span id="cb101-816"><a href="#cb101-816" aria-hidden="true" tabindex="-1"></a><span class="co">#design_test=MS(vars_test).fit(College_valid)</span></span>
<span id="cb101-817"><a href="#cb101-817" aria-hidden="true" tabindex="-1"></a><span class="co">#X_test=design.transform(College_valid)</span></span>
<span id="cb101-818"><a href="#cb101-818" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> np.column_stack([College_valid[<span class="st">'Accept'</span>],College_valid[<span class="st">'Expend'</span>],</span>
<span id="cb101-819"><a href="#cb101-819" aria-hidden="true" tabindex="-1"></a>                          College_valid[<span class="st">'F.Undergrad'</span>],College_valid[<span class="st">'Grad.Rate'</span>],</span>
<span id="cb101-820"><a href="#cb101-820" aria-hidden="true" tabindex="-1"></a>                        College_valid[<span class="st">'Personal'</span>], </span>
<span id="cb101-821"><a href="#cb101-821" aria-hidden="true" tabindex="-1"></a>                          College_valid[<span class="st">'Private'</span>].cat.codes,College_valid[<span class="st">'Room.Board'</span>],</span>
<span id="cb101-822"><a href="#cb101-822" aria-hidden="true" tabindex="-1"></a>                        College_valid[<span class="st">'Terminal'</span>],College_valid[<span class="st">'Top10perc'</span>],</span>
<span id="cb101-823"><a href="#cb101-823" aria-hidden="true" tabindex="-1"></a>                          College_valid[<span class="st">'perc.alumni'</span>]])</span>
<span id="cb101-824"><a href="#cb101-824" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-825"><a href="#cb101-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-828"><a href="#cb101-828" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-829"><a href="#cb101-829" aria-hidden="true" tabindex="-1"></a>test_preds<span class="op">=</span>gam2.predict(X_test)</span>
<span id="cb101-830"><a href="#cb101-830" aria-hidden="true" tabindex="-1"></a>r2_score(y_test,test_preds)</span>
<span id="cb101-831"><a href="#cb101-831" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-832"><a href="#cb101-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-833"><a href="#cb101-833" aria-hidden="true" tabindex="-1"></a>The $R^2$ metric is nearly 80%, which is a sign of good fit.</span>
<span id="cb101-834"><a href="#cb101-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-835"><a href="#cb101-835" aria-hidden="true" tabindex="-1"></a><span class="fu">### (d)</span></span>
<span id="cb101-836"><a href="#cb101-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-839"><a href="#cb101-839" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-840"><a href="#cb101-840" aria-hidden="true" tabindex="-1"></a>gam.summary()</span>
<span id="cb101-841"><a href="#cb101-841" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-842"><a href="#cb101-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-845"><a href="#cb101-845" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-846"><a href="#cb101-846" aria-hidden="true" tabindex="-1"></a>gam2.summary()</span>
<span id="cb101-847"><a href="#cb101-847" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-848"><a href="#cb101-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-849"><a href="#cb101-849" aria-hidden="true" tabindex="-1"></a>Using stepwise forward selection was a bad idea. The number of observations seem insufficient to bring stable results. Splitting the already small dataset made things worse (Steyerberg et al. show that there must be at least 50 observations per feature to have acceptable results using stepwise selection. See : Prognostic modeling with logistic regression analysis: in search of a sensible strategy in small data sets. ). pvalues don't reflect the correct values and hence are not reliable. In a more realistic case we should avoid stepwise selection and opt for other approaches for feature selection like ridge regression.</span>
<span id="cb101-850"><a href="#cb101-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-851"><a href="#cb101-851" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercise 11</span></span>
<span id="cb101-852"><a href="#cb101-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-853"><a href="#cb101-853" aria-hidden="true" tabindex="-1"></a><span class="fu">### (a)</span></span>
<span id="cb101-854"><a href="#cb101-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-857"><a href="#cb101-857" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-858"><a href="#cb101-858" aria-hidden="true" tabindex="-1"></a>n<span class="op">=</span><span class="dv">100</span></span>
<span id="cb101-859"><a href="#cb101-859" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">12</span>)</span>
<span id="cb101-860"><a href="#cb101-860" aria-hidden="true" tabindex="-1"></a>X1<span class="op">=</span>np.random.randn(n)</span>
<span id="cb101-861"><a href="#cb101-861" aria-hidden="true" tabindex="-1"></a>X2<span class="op">=</span>np.random.randn(n)</span>
<span id="cb101-862"><a href="#cb101-862" aria-hidden="true" tabindex="-1"></a>epsilon<span class="op">=</span>np.random.randn(n)</span>
<span id="cb101-863"><a href="#cb101-863" aria-hidden="true" tabindex="-1"></a>beta<span class="op">=</span>[<span class="fl">0.5</span>,<span class="dv">1</span>,<span class="fl">1.5</span>]</span>
<span id="cb101-864"><a href="#cb101-864" aria-hidden="true" tabindex="-1"></a>Y<span class="op">=</span>beta[<span class="dv">0</span>]<span class="op">+</span>beta[<span class="dv">1</span>]<span class="op">*</span>X1<span class="op">+</span>beta[<span class="dv">2</span>]<span class="op">*</span>X2<span class="op">+</span>epsilon</span>
<span id="cb101-865"><a href="#cb101-865" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-866"><a href="#cb101-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-867"><a href="#cb101-867" aria-hidden="true" tabindex="-1"></a><span class="fu">### (b)</span></span>
<span id="cb101-868"><a href="#cb101-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-871"><a href="#cb101-871" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-872"><a href="#cb101-872" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> simple_reg(outcome,feature):</span>
<span id="cb101-873"><a href="#cb101-873" aria-hidden="true" tabindex="-1"></a>    df<span class="op">=</span>pd.DataFrame({<span class="st">'outcome'</span>:outcome,<span class="st">'feature'</span>:feature})</span>
<span id="cb101-874"><a href="#cb101-874" aria-hidden="true" tabindex="-1"></a>    design<span class="op">=</span>MS([<span class="st">'feature'</span>])</span>
<span id="cb101-875"><a href="#cb101-875" aria-hidden="true" tabindex="-1"></a>    X<span class="op">=</span>design.fit_transform(df)</span>
<span id="cb101-876"><a href="#cb101-876" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>sm.OLS(outcome,X)</span>
<span id="cb101-877"><a href="#cb101-877" aria-hidden="true" tabindex="-1"></a>    result<span class="op">=</span>model.fit()</span>
<span id="cb101-878"><a href="#cb101-878" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result.params[<span class="dv">0</span>],result.params[<span class="dv">1</span>]</span>
<span id="cb101-879"><a href="#cb101-879" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-880"><a href="#cb101-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-881"><a href="#cb101-881" aria-hidden="true" tabindex="-1"></a><span class="fu">### (c)</span></span>
<span id="cb101-882"><a href="#cb101-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-885"><a href="#cb101-885" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-886"><a href="#cb101-886" aria-hidden="true" tabindex="-1"></a>beta1<span class="op">=</span><span class="dv">7</span></span>
<span id="cb101-887"><a href="#cb101-887" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-888"><a href="#cb101-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-889"><a href="#cb101-889" aria-hidden="true" tabindex="-1"></a><span class="fu">### (d)</span></span>
<span id="cb101-890"><a href="#cb101-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-893"><a href="#cb101-893" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-894"><a href="#cb101-894" aria-hidden="true" tabindex="-1"></a>beta0<span class="op">=</span>simple_reg(Y<span class="op">-</span>beta1<span class="op">*</span>X1,X2)[<span class="dv">0</span>]</span>
<span id="cb101-895"><a href="#cb101-895" aria-hidden="true" tabindex="-1"></a>beta2<span class="op">=</span>simple_reg(Y<span class="op">-</span>beta1<span class="op">*</span>X1,X2)[<span class="dv">1</span>]</span>
<span id="cb101-896"><a href="#cb101-896" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-897"><a href="#cb101-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-898"><a href="#cb101-898" aria-hidden="true" tabindex="-1"></a><span class="fu">### (e)</span></span>
<span id="cb101-899"><a href="#cb101-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-902"><a href="#cb101-902" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-903"><a href="#cb101-903" aria-hidden="true" tabindex="-1"></a>beta0<span class="op">=</span>simple_reg(Y<span class="op">-</span>beta2<span class="op">*</span>X2,X1)[<span class="dv">0</span>]</span>
<span id="cb101-904"><a href="#cb101-904" aria-hidden="true" tabindex="-1"></a>beta1<span class="op">=</span>simple_reg(Y<span class="op">-</span>beta2<span class="op">*</span>X2,X1)[<span class="dv">1</span>]</span>
<span id="cb101-905"><a href="#cb101-905" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-906"><a href="#cb101-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-907"><a href="#cb101-907" aria-hidden="true" tabindex="-1"></a><span class="fu">### (f)</span></span>
<span id="cb101-908"><a href="#cb101-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-909"><a href="#cb101-909" aria-hidden="true" tabindex="-1"></a>For more accuracy we should rename betas found in both questions d and e by betahat in order to distinguish theme from real betas chosen in the beginning of the exercise</span>
<span id="cb101-910"><a href="#cb101-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-913"><a href="#cb101-913" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-914"><a href="#cb101-914" aria-hidden="true" tabindex="-1"></a>betahat<span class="op">=</span>[beta0,beta1,beta2]</span>
<span id="cb101-915"><a href="#cb101-915" aria-hidden="true" tabindex="-1"></a>list_beta0<span class="op">=</span>[betahat[<span class="dv">0</span>]]</span>
<span id="cb101-916"><a href="#cb101-916" aria-hidden="true" tabindex="-1"></a>list_beta1<span class="op">=</span>[betahat[<span class="dv">1</span>]]</span>
<span id="cb101-917"><a href="#cb101-917" aria-hidden="true" tabindex="-1"></a>list_beta2<span class="op">=</span>[betahat[<span class="dv">2</span>]]</span>
<span id="cb101-918"><a href="#cb101-918" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1000</span>):</span>
<span id="cb101-919"><a href="#cb101-919" aria-hidden="true" tabindex="-1"></a>    list_beta2.append(simple_reg(Y<span class="op">-</span>list_beta1[i]<span class="op">*</span>X1,X2)[<span class="dv">1</span>])</span>
<span id="cb101-920"><a href="#cb101-920" aria-hidden="true" tabindex="-1"></a>    list_beta0.append(simple_reg(Y<span class="op">-</span>list_beta2[i]<span class="op">*</span>X2,X1)[<span class="dv">0</span>])</span>
<span id="cb101-921"><a href="#cb101-921" aria-hidden="true" tabindex="-1"></a>    list_beta1.append(simple_reg(Y<span class="op">-</span>list_beta2[i]<span class="op">*</span>X2,X1)[<span class="dv">1</span>])</span>
<span id="cb101-922"><a href="#cb101-922" aria-hidden="true" tabindex="-1"></a>betahat<span class="op">=</span>[list_beta0[<span class="op">-</span><span class="dv">1</span>],list_beta1[<span class="op">-</span><span class="dv">1</span>],list_beta2[<span class="op">-</span><span class="dv">1</span>]]</span>
<span id="cb101-923"><a href="#cb101-923" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-924"><a href="#cb101-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-927"><a href="#cb101-927" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-928"><a href="#cb101-928" aria-hidden="true" tabindex="-1"></a>betahat</span>
<span id="cb101-929"><a href="#cb101-929" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-930"><a href="#cb101-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-933"><a href="#cb101-933" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-934"><a href="#cb101-934" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="dv">1</span>,<span class="dv">1002</span>),list_beta0,label <span class="op">=</span> <span class="st">'Beta0'</span>)</span>
<span id="cb101-935"><a href="#cb101-935" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="dv">1</span>,<span class="dv">1002</span>),list_beta1,label <span class="op">=</span> <span class="st">'Beta1'</span>)</span>
<span id="cb101-936"><a href="#cb101-936" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="dv">1</span>,<span class="dv">1002</span>),list_beta2,label <span class="op">=</span> <span class="st">'Beta2'</span>)</span>
<span id="cb101-937"><a href="#cb101-937" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb101-938"><a href="#cb101-938" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Number of iterations'</span>)<span class="op">;</span></span>
<span id="cb101-939"><a href="#cb101-939" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-940"><a href="#cb101-940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-941"><a href="#cb101-941" aria-hidden="true" tabindex="-1"></a><span class="fu">### (g)</span></span>
<span id="cb101-942"><a href="#cb101-942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-945"><a href="#cb101-945" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-946"><a href="#cb101-946" aria-hidden="true" tabindex="-1"></a>df<span class="op">=</span>pd.DataFrame({<span class="st">'y'</span>:Y,<span class="st">'X1'</span>:X1,<span class="st">'X2'</span>:X2})</span>
<span id="cb101-947"><a href="#cb101-947" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> MS([<span class="st">'X1'</span>, <span class="st">'X2'</span>]).fit_transform(df)</span>
<span id="cb101-948"><a href="#cb101-948" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> sm.OLS(Y, X)</span>
<span id="cb101-949"><a href="#cb101-949" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> model.fit()</span>
<span id="cb101-950"><a href="#cb101-950" aria-hidden="true" tabindex="-1"></a>summarize(results)</span>
<span id="cb101-951"><a href="#cb101-951" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-952"><a href="#cb101-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-953"><a href="#cb101-953" aria-hidden="true" tabindex="-1"></a>Both methods used in questions g and f yield the same results. As for Betahat, we notice that they are close to the real coefficients defined in question a.</span>
<span id="cb101-954"><a href="#cb101-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-955"><a href="#cb101-955" aria-hidden="true" tabindex="-1"></a><span class="fu">### (h)</span></span>
<span id="cb101-956"><a href="#cb101-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-957"><a href="#cb101-957" aria-hidden="true" tabindex="-1"></a>We can limlit the x axis of the previous graph to visualize after the number of iterations after which the coefficients converge.</span>
<span id="cb101-958"><a href="#cb101-958" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-961"><a href="#cb101-961" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-962"><a href="#cb101-962" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="dv">1</span>,<span class="dv">1002</span>),list_beta0,label <span class="op">=</span> <span class="st">'Beta0'</span>)</span>
<span id="cb101-963"><a href="#cb101-963" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="dv">1</span>,<span class="dv">1002</span>),list_beta1,label <span class="op">=</span> <span class="st">'Beta1'</span>)</span>
<span id="cb101-964"><a href="#cb101-964" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="dv">1</span>,<span class="dv">1002</span>),list_beta2,label <span class="op">=</span> <span class="st">'Beta2'</span>)</span>
<span id="cb101-965"><a href="#cb101-965" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb101-966"><a href="#cb101-966" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Number of iterations'</span>)</span>
<span id="cb101-967"><a href="#cb101-967" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="dv">0</span>,<span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb101-968"><a href="#cb101-968" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-969"><a href="#cb101-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-970"><a href="#cb101-970" aria-hidden="true" tabindex="-1"></a>After only 3 iterations, obtained results for the coefficients become stable.</span>
<span id="cb101-971"><a href="#cb101-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-972"><a href="#cb101-972" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercise 12</span></span>
<span id="cb101-973"><a href="#cb101-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-976"><a href="#cb101-976" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-977"><a href="#cb101-977" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">45</span>)</span>
<span id="cb101-978"><a href="#cb101-978" aria-hidden="true" tabindex="-1"></a>X<span class="op">=</span>np.random.rand(<span class="dv">100</span>,<span class="dv">100</span>)</span>
<span id="cb101-979"><a href="#cb101-979" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> np.random.randn(<span class="dv">1</span>)</span>
<span id="cb101-980"><a href="#cb101-980" aria-hidden="true" tabindex="-1"></a>beta<span class="op">=</span>np.random.randn(<span class="dv">100</span>)</span>
<span id="cb101-981"><a href="#cb101-981" aria-hidden="true" tabindex="-1"></a>epsilon<span class="op">=</span>np.random.randn(<span class="dv">100</span>)</span>
<span id="cb101-982"><a href="#cb101-982" aria-hidden="true" tabindex="-1"></a>Y<span class="op">=</span>c<span class="op">+</span>np.matmul(X,beta)<span class="op">+</span>epsilon</span>
<span id="cb101-983"><a href="#cb101-983" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-984"><a href="#cb101-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-987"><a href="#cb101-987" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-988"><a href="#cb101-988" aria-hidden="true" tabindex="-1"></a>lm<span class="op">=</span> LinearRegression()</span>
<span id="cb101-989"><a href="#cb101-989" aria-hidden="true" tabindex="-1"></a>(Y).shape</span>
<span id="cb101-990"><a href="#cb101-990" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-991"><a href="#cb101-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-994"><a href="#cb101-994" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-995"><a href="#cb101-995" aria-hidden="true" tabindex="-1"></a>Xn<span class="op">=</span>np.delete(X,<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb101-996"><a href="#cb101-996" aria-hidden="true" tabindex="-1"></a>df<span class="op">=</span>pd.DataFrame(X, columns <span class="op">=</span> [<span class="st">'Column_'</span><span class="op">+</span><span class="bu">str</span>(i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>)])</span>
<span id="cb101-997"><a href="#cb101-997" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-998"><a href="#cb101-998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1001"><a href="#cb101-1001" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-1002"><a href="#cb101-1002" aria-hidden="true" tabindex="-1"></a>mul_beta_hat<span class="op">=</span>np.zeros(<span class="dv">100</span>)<span class="co">#beta estimators obtained by multiple linear regression</span></span>
<span id="cb101-1003"><a href="#cb101-1003" aria-hidden="true" tabindex="-1"></a>design <span class="op">=</span> MS(df).fit_transform(df)</span>
<span id="cb101-1004"><a href="#cb101-1004" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> sm.OLS(Y, design).fit()</span>
<span id="cb101-1005"><a href="#cb101-1005" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>):</span>
<span id="cb101-1006"><a href="#cb101-1006" aria-hidden="true" tabindex="-1"></a>    mul_beta_hat[j]<span class="op">=</span>result.params[<span class="dv">1</span>:].values[j]</span>
<span id="cb101-1007"><a href="#cb101-1007" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-1008"><a href="#cb101-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1011"><a href="#cb101-1011" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-1012"><a href="#cb101-1012" aria-hidden="true" tabindex="-1"></a> mul_beta_hat.shape</span>
<span id="cb101-1013"><a href="#cb101-1013" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-1014"><a href="#cb101-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1017"><a href="#cb101-1017" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-1018"><a href="#cb101-1018" aria-hidden="true" tabindex="-1"></a>n_iter<span class="op">=</span><span class="dv">100</span><span class="co">#number of iterations</span></span>
<span id="cb101-1019"><a href="#cb101-1019" aria-hidden="true" tabindex="-1"></a>mse<span class="op">=</span>np.zeros(n_iter)<span class="co">#mean squared error of the backfitted linear regression</span></span>
<span id="cb101-1020"><a href="#cb101-1020" aria-hidden="true" tabindex="-1"></a>diff_mse<span class="op">=</span>np.zeros(n_iter)<span class="co">#mean squared error among betas obtained by backfit and betas obtained by</span></span>
<span id="cb101-1021"><a href="#cb101-1021" aria-hidden="true" tabindex="-1"></a><span class="co">#multiple linear regression</span></span>
<span id="cb101-1022"><a href="#cb101-1022" aria-hidden="true" tabindex="-1"></a>c_hat<span class="op">=</span>np.zeros((n_iter,<span class="dv">100</span>))<span class="co">#intercept estimators obtained by backfit</span></span>
<span id="cb101-1023"><a href="#cb101-1023" aria-hidden="true" tabindex="-1"></a>beta_hat<span class="op">=</span>np.zeros((n_iter,<span class="dv">100</span>))<span class="co">#beta estimators obtained by backfit</span></span>
<span id="cb101-1024"><a href="#cb101-1024" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(n_iter):</span>
<span id="cb101-1025"><a href="#cb101-1025" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>):</span>
<span id="cb101-1026"><a href="#cb101-1026" aria-hidden="true" tabindex="-1"></a>        beta_hat_i<span class="op">=</span>np.delete(beta_hat[j,:],i,<span class="dv">0</span>)</span>
<span id="cb101-1027"><a href="#cb101-1027" aria-hidden="true" tabindex="-1"></a>        term<span class="op">=</span>np.matmul(np.concatenate((X[:,:i], X[:,i<span class="op">+</span><span class="dv">1</span>:]), axis<span class="op">=</span><span class="dv">1</span>),beta_hat_i)</span>
<span id="cb101-1028"><a href="#cb101-1028" aria-hidden="true" tabindex="-1"></a>        c_hat[j:n_iter,i]<span class="op">=</span>lm.fit(X[:,i].reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>),Y<span class="op">-</span>term).intercept_</span>
<span id="cb101-1029"><a href="#cb101-1029" aria-hidden="true" tabindex="-1"></a>        beta_hat[j:n_iter,i]<span class="op">=</span>lm.fit(X[:,i].reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>),Y<span class="op">-</span>term).coef_[<span class="dv">0</span>]</span>
<span id="cb101-1030"><a href="#cb101-1030" aria-hidden="true" tabindex="-1"></a>    mse[j]<span class="op">=</span>mean_squared_error(Y, c_hat[j,i]<span class="op">+</span>np.matmul(X,beta_hat[j,:]))</span>
<span id="cb101-1031"><a href="#cb101-1031" aria-hidden="true" tabindex="-1"></a>    diff_mse[j]<span class="op">=</span>mean_squared_error(mul_beta_hat,beta_hat[j,:])</span>
<span id="cb101-1032"><a href="#cb101-1032" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-1033"><a href="#cb101-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1036"><a href="#cb101-1036" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-1037"><a href="#cb101-1037" aria-hidden="true" tabindex="-1"></a>ax<span class="op">=</span>subplots(figsize<span class="op">=</span>(<span class="dv">20</span>,<span class="dv">20</span>))[<span class="dv">1</span>]</span>
<span id="cb101-1038"><a href="#cb101-1038" aria-hidden="true" tabindex="-1"></a>ax.scatter(<span class="bu">range</span>(<span class="dv">1</span>,n_iter<span class="op">+</span><span class="dv">1</span>), mse)</span>
<span id="cb101-1039"><a href="#cb101-1039" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Nth iteration'</span>)</span>
<span id="cb101-1040"><a href="#cb101-1040" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Backfitting MSE for Y'</span>) </span>
<span id="cb101-1041"><a href="#cb101-1041" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">' MSE '</span>) <span class="op">;</span></span>
<span id="cb101-1042"><a href="#cb101-1042" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-1043"><a href="#cb101-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1046"><a href="#cb101-1046" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb101-1047"><a href="#cb101-1047" aria-hidden="true" tabindex="-1"></a>ax<span class="op">=</span>subplots(figsize<span class="op">=</span>(<span class="dv">20</span>,<span class="dv">20</span>))[<span class="dv">1</span>]</span>
<span id="cb101-1048"><a href="#cb101-1048" aria-hidden="true" tabindex="-1"></a>ax.scatter(<span class="bu">range</span>(<span class="dv">1</span>,n_iter<span class="op">+</span><span class="dv">1</span>), diff_mse)</span>
<span id="cb101-1049"><a href="#cb101-1049" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Nth iteration'</span>)</span>
<span id="cb101-1050"><a href="#cb101-1050" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'MLR beats vs Backfitting betas'</span>) </span>
<span id="cb101-1051"><a href="#cb101-1051" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">' MSE '</span>) <span class="op">;</span></span>
<span id="cb101-1052"><a href="#cb101-1052" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-1053"><a href="#cb101-1053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1054"><a href="#cb101-1054" aria-hidden="true" tabindex="-1"></a>After 20 iterations mean square errors differences are with the last iteration are considered negligeable.</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>